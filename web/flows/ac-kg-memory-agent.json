{
  "id": "ac-kg-memory-agent",
  "name": "AbstractCode KG-Memory Agent (v0)",
  "description": "RunnableFlow agent with KG recall + end-of-turn KG ingestion (extract → assert). Designed for per-turn memory reconstruction experiments.",
  "interfaces": [
    "abstractcode.agent.v1"
  ],
  "nodes": [
    {
      "id": "start",
      "type": "on_flow_start",
      "position": {
        "x": -960.0,
        "y": 0.0
      },
      "data": {
        "nodeType": "on_flow_start",
        "label": "On Flow Start",
        "icon": "&#x1F3C1;",
        "headerColor": "#C0392B",
        "inputs": [],
        "outputs": [
          {
            "id": "exec-out",
            "label": "",
            "type": "execution"
          },
          {
            "id": "use_context",
            "label": "use_context",
            "type": "boolean"
          },
          {
            "id": "memory",
            "label": "memory",
            "type": "memory"
          },
          {
            "id": "context",
            "label": "context",
            "type": "object"
          },
          {
            "id": "provider",
            "label": "provider",
            "type": "provider"
          },
          {
            "id": "model",
            "label": "model",
            "type": "model"
          },
          {
            "id": "system",
            "label": "system",
            "type": "string"
          },
          {
            "id": "prompt",
            "label": "prompt",
            "type": "string"
          },
          {
            "id": "tools",
            "label": "tools",
            "type": "tools"
          },
          {
            "id": "max_iterations",
            "label": "max_iterations",
            "type": "number"
          },
          {
            "id": "max_in_tokens",
            "label": "max_in_tokens",
            "type": "number"
          },
          {
            "id": "temperature",
            "label": "temperature",
            "type": "number"
          },
          {
            "id": "seed",
            "label": "seed",
            "type": "number"
          },
          {
            "id": "resp_schema",
            "label": "resp_schema",
            "type": "object"
          }
        ],
        "pinDefaults": {
          "use_context": true,
          "memory": {},
          "system": "You are a helpful assistant. Use the provided \"## KG ACTIVE MEMORY\" system block (when present) as retrieved memory from a temporal knowledge graph: it contains relevant facts and relationships. When uncertain, ask clarifying questions.\n\nAfter you respond, the workflow will extract durable facts from this turn and assert them into the KG for next-turn recall."
        }
      }
    },
    {
      "id": "memory_default",
      "type": "literal_json",
      "position": {
        "x": -960.0,
        "y": 240.0
      },
      "data": {
        "nodeType": "literal_json",
        "label": "Memory (defaults)",
        "icon": "&#x1F4BE;",
        "headerColor": "#00C49A",
        "inputs": [],
        "outputs": [
          {
            "id": "value",
            "label": "memory",
            "type": "memory"
          }
        ],
        "literalValue": {
          "use_session_attachments": true,
          "use_span_memory": false,
          "use_semantic_search": false,
          "use_kg_memory": true,
          "memory_query": "",
          "memory_scope": "all",
          "recall_level": "standard",
          "max_span_messages": 24,
          "kg_max_input_tokens": 1200,
          "kg_limit": 80,
          "kg_min_score": 0.35,
          "kg_write_scope": "session",
          "kg_domain_focus": "software / agents / memory systems",
          "kg_max_out_tokens": 0
        }
      }
    },
    {
      "id": "memory_effective",
      "type": "merge",
      "position": {
        "x": -736.0,
        "y": 240.0
      },
      "data": {
        "nodeType": "merge",
        "label": "Memory",
        "icon": "&#x1F517;",
        "headerColor": "#00C49A",
        "inputs": [
          {
            "id": "a",
            "label": "a",
            "type": "memory"
          },
          {
            "id": "b",
            "label": "b",
            "type": "memory"
          }
        ],
        "outputs": [
          {
            "id": "result",
            "label": "memory",
            "type": "memory"
          }
        ]
      }
    },
    {
      "id": "mem_write_scope",
      "type": "get",
      "position": {
        "x": -512.0,
        "y": 176.0
      },
      "data": {
        "nodeType": "get",
        "label": "kg_write_scope",
        "icon": "&#x1F4E5;",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "object",
            "label": "object",
            "type": "object"
          },
          {
            "id": "key",
            "label": "key",
            "type": "string"
          },
          {
            "id": "default",
            "label": "default",
            "type": "any"
          }
        ],
        "outputs": [
          {
            "id": "value",
            "label": "value",
            "type": "any"
          }
        ],
        "pinDefaults": {
          "key": "kg_write_scope",
          "default": "session"
        }
      }
    },
    {
      "id": "mem_domain_focus",
      "type": "get",
      "position": {
        "x": -512.0,
        "y": 256.0
      },
      "data": {
        "nodeType": "get",
        "label": "kg_domain_focus",
        "icon": "&#x1F4E5;",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "object",
            "label": "object",
            "type": "object"
          },
          {
            "id": "key",
            "label": "key",
            "type": "string"
          },
          {
            "id": "default",
            "label": "default",
            "type": "any"
          }
        ],
        "outputs": [
          {
            "id": "value",
            "label": "value",
            "type": "any"
          }
        ],
        "pinDefaults": {
          "key": "kg_domain_focus",
          "default": "software / agents / memory systems"
        }
      }
    },
    {
      "id": "mem_max_out_tokens",
      "type": "get",
      "position": {
        "x": -512.0,
        "y": 336.0
      },
      "data": {
        "nodeType": "get",
        "label": "kg_max_out_tokens",
        "icon": "&#x1F4E5;",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "object",
            "label": "object",
            "type": "object"
          },
          {
            "id": "key",
            "label": "key",
            "type": "string"
          },
          {
            "id": "default",
            "label": "default",
            "type": "any"
          }
        ],
        "outputs": [
          {
            "id": "value",
            "label": "value",
            "type": "any"
          }
        ],
        "pinDefaults": {
          "key": "kg_max_out_tokens",
          "default": 0
        }
      }
    },
    {
      "id": "agent",
      "type": "agent",
      "position": {
        "x": -576.0,
        "y": 0.0
      },
      "data": {
        "nodeType": "agent",
        "label": "Agent (KG recall)",
        "icon": "&#x1F916;",
        "headerColor": "#4488FF",
        "inputs": [
          {
            "id": "exec-in",
            "label": "",
            "type": "execution"
          },
          {
            "id": "use_context",
            "label": "use_context",
            "type": "boolean"
          },
          {
            "id": "context",
            "label": "context",
            "type": "object"
          },
          {
            "id": "memory",
            "label": "memory",
            "type": "memory"
          },
          {
            "id": "provider",
            "label": "provider",
            "type": "provider"
          },
          {
            "id": "model",
            "label": "model",
            "type": "model"
          },
          {
            "id": "system",
            "label": "system",
            "type": "string"
          },
          {
            "id": "prompt",
            "label": "prompt",
            "type": "string"
          },
          {
            "id": "tools",
            "label": "tools",
            "type": "tools"
          },
          {
            "id": "max_iterations",
            "label": "max_iterations",
            "type": "number"
          },
          {
            "id": "max_in_tokens",
            "label": "max_in_tokens",
            "type": "number"
          },
          {
            "id": "temperature",
            "label": "temperature",
            "type": "number"
          },
          {
            "id": "seed",
            "label": "seed",
            "type": "number"
          },
          {
            "id": "resp_schema",
            "label": "resp_schema",
            "type": "object"
          }
        ],
        "outputs": [
          {
            "id": "exec-out",
            "label": "",
            "type": "execution"
          },
          {
            "id": "response",
            "label": "response",
            "type": "string"
          },
          {
            "id": "success",
            "label": "success",
            "type": "boolean"
          },
          {
            "id": "meta",
            "label": "meta",
            "type": "object"
          },
          {
            "id": "scratchpad",
            "label": "scratchpad",
            "type": "object"
          }
        ],
        "agentConfig": {
          "provider": "lmstudio",
          "model": "qwen/qwen3-next-80b",
          "tools": [],
          "max_iterations": 25
        }
      }
    },
    {
      "id": "turn_vars",
      "type": "make_object",
      "position": {
        "x": -576.0,
        "y": 240.0
      },
      "data": {
        "nodeType": "make_object",
        "label": "Turn vars",
        "icon": "{}",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "prompt",
            "label": "prompt",
            "type": "string"
          },
          {
            "id": "response",
            "label": "response",
            "type": "string"
          }
        ],
        "outputs": [
          {
            "id": "result",
            "label": "result",
            "type": "object"
          }
        ]
      }
    },
    {
      "id": "turn_text",
      "type": "string_template",
      "position": {
        "x": -352.0,
        "y": 240.0
      },
      "data": {
        "nodeType": "string_template",
        "label": "Turn transcript",
        "icon": "&#x1F4DD;",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "template",
            "label": "template",
            "type": "string"
          },
          {
            "id": "vars",
            "label": "vars",
            "type": "object"
          }
        ],
        "outputs": [
          {
            "id": "result",
            "label": "result",
            "type": "string"
          }
        ],
        "pinDefaults": {
          "template": "USER: {{prompt}}\\n\\nASSISTANT: {{response}}"
        }
      }
    },
	    {
	      "id": "kg_sources",
	      "type": "code",
      "position": {
        "x": -352.0,
        "y": 384.0
      },
      "data": {
        "nodeType": "code",
        "label": "KG evidence sources",
        "icon": "&#x1F40D;",
        "headerColor": "#9B59B6",
        "inputs": [
          {
            "id": "exec-in",
            "label": "",
            "type": "execution"
          },
          {
            "id": "input",
            "label": "scratchpad",
            "type": "any"
          }
        ],
        "outputs": [
          {
            "id": "exec-out",
            "label": "",
            "type": "execution"
          },
          {
            "id": "output",
            "label": "sources",
            "type": "any"
          }
        ],
        "functionName": "transform",
        "code": "def transform(_input):\n    sp = _input.get('input') if isinstance(_input, dict) else None\n    if not isinstance(sp, dict):\n        return []\n\n    node_traces = sp.get('node_traces')\n    if not isinstance(node_traces, dict):\n        return []\n\n    def _as_dict(v):\n        return v if isinstance(v, dict) else None\n\n    def _safe_str(v):\n        return v if isinstance(v, str) else str(v or '')\n\n    def _stringify(value, *, max_chars):\n        # VisualFlow code nodes disallow imports; use a deterministic repr for structured values.\n        try:\n            if isinstance(value, (dict, list)):\n                s = repr(value)\n            else:\n                s = _safe_str(value)\n        except Exception:\n            s = _safe_str(value)\n        if max_chars and isinstance(max_chars, int) and max_chars > 0 and len(s) > max_chars:\n            #[WARNING:TRUNCATION]\n            suffix = f\"\\n… [TRUNCATED max_chars={max_chars}]\"\n            keep = max(0, int(max_chars) - len(suffix))\n            if keep <= 0:\n                return suffix.strip()\n            return s[:keep].rstrip() + suffix\n        return s\n\n    def _tool_output_for_md(tool_name, output):\n        # Avoid dumping large text blobs into the tool-output evidence source.\n        if tool_name == 'open_attachment' and isinstance(output, dict):\n            meta = {}\n            for k in (\n                'artifact_id',\n                'title',\n                'content_type',\n                'derived_from_content_type',\n                'derived_text_content_type',\n                'truncated',\n                'error',\n                'derived_error',\n            ):\n                if k in output and output.get(k) is not None:\n                    meta[k] = output.get(k)\n            ct = output.get('content_text')\n            if isinstance(ct, str):\n                meta['content_text_chars'] = len(ct)\n            rend = output.get('rendered')\n            if isinstance(rend, str):\n                meta['rendered_chars'] = len(rend)\n            return meta\n        return output\n\n    # Optional cap. 0/None means \"no cap\".\n    max_total_chars = sp.get('max_tool_outputs_chars')\n    if max_total_chars is None:\n        max_total_chars = sp.get('kg_max_tool_outputs_chars')\n    try:\n        max_total_chars = int(max_total_chars) if max_total_chars is not None else 0\n    except Exception:\n        max_total_chars = 0\n    if max_total_chars <= 0:\n        max_total_chars = 0\n\n    # Collect tool calls + results across all trace steps.\n    calls = []\n    for trace_any in node_traces.values():\n        trace = _as_dict(trace_any)\n        if not trace:\n            continue\n        steps = trace.get('steps')\n        if not isinstance(steps, list):\n            continue\n        for step_any in steps:\n            step = _as_dict(step_any)\n            if not step:\n                continue\n            effect = _as_dict(step.get('effect')) or {}\n            if _safe_str(effect.get('type')).strip() != 'tool_calls':\n                continue\n            payload = _as_dict(effect.get('payload')) or {}\n            tool_calls = payload.get('tool_calls')\n            if isinstance(tool_calls, dict):\n                tool_calls = [tool_calls]\n            if not isinstance(tool_calls, list):\n                tool_calls = []\n            result = _as_dict(step.get('result')) or {}\n            results = result.get('results')\n            if isinstance(results, dict):\n                results = [results]\n            if not isinstance(results, list):\n                results = []\n            results_by_id = {}\n            for r_any in results:\n                r = _as_dict(r_any)\n                if not r:\n                    continue\n                cid = _safe_str(r.get('call_id')).strip()\n                if cid:\n                    results_by_id[cid] = r\n            for c_any in tool_calls:\n                c = _as_dict(c_any)\n                if not c:\n                    continue\n                cid = _safe_str(c.get('call_id') or c.get('id')).strip()\n                r = results_by_id.get(cid) if cid else None\n                calls.append({'call': c, 'result': r})\n\n    if not calls:\n        return []\n\n    tools_used = []\n    attachment_ids = []\n\n    blocks = ['## Tool outputs']\n    total_chars = 0\n    tool_outputs_truncated = False\n\n    for item in calls:\n        c = item.get('call') if isinstance(item, dict) else None\n        r = item.get('result') if isinstance(item, dict) else None\n        c = c if isinstance(c, dict) else {}\n        r = r if isinstance(r, dict) else {}\n\n        name = _safe_str(c.get('name')).strip() or 'tool'\n        tools_used.append(name)\n        cid = _safe_str(c.get('call_id') or c.get('id')).strip()\n        args = c.get('arguments') if isinstance(c.get('arguments'), dict) else {}\n\n        success = r.get('success') if isinstance(r.get('success'), bool) else None\n        error = r.get('error')\n        output = r.get('output')\n\n        # Best-effort: extract attachment artifact ids.\n        if name == 'open_attachment' and isinstance(output, dict):\n            aid = output.get('artifact_id')\n            aid = _safe_str(aid).strip()\n            if aid:\n                attachment_ids.append(aid)\n\n        output_for_md = _tool_output_for_md(name, output)\n\n        entry = []\n        entry.append(f\"- `{name}`\" + (f\" (call_id={cid})\" if cid else ''))\n        entry.append('')\n        entry.append('**arguments**')\n        entry.append('```json')\n        entry.append(_stringify(args, max_chars=2000))\n        entry.append('```')\n        entry.append('')\n        entry.append('**result**')\n        if success is not None:\n            entry.append(f\"- success: {str(success).lower()}\")\n        if error is not None:\n            entry.append(f\"- error: {_safe_str(error)}\")\n        entry.append('```')\n        entry.append(_stringify(output_for_md, max_chars=4000))\n        entry.append('```')\n        entry.append('')\n\n        s = '\\n'.join(entry).strip() + '\\n'\n        total_chars += len(s)\n        if max_total_chars and total_chars > max_total_chars:\n            #[WARNING:TRUNCATION]\n            blocks.append(f\"_(tool outputs truncated: max_tool_outputs_chars={max_total_chars})_\")\n            tool_outputs_truncated = True\n            break\n        blocks.append(s)\n\n    tool_outputs_md = '\\n'.join(blocks).strip()\n\n    uniq_tools = []\n    seen = set()\n    for t in tools_used:\n        if t in seen:\n            continue\n        seen.add(t)\n        uniq_tools.append(t)\n\n    summary_lines = [\n        '## Work summary',\n        f\"- tool_calls: {len(calls)}\",\n        f\"- tools: {', '.join(uniq_tools) if uniq_tools else '(none)'}\",\n    ]\n    if attachment_ids:\n        uniq_a = []\n        seen2 = set()\n        for aid in attachment_ids:\n            if aid in seen2:\n                continue\n            seen2.add(aid)\n            uniq_a.append(aid)\n        summary_lines.append(f\"- attachments_used: {', '.join(uniq_a)}\")\n\n    work_summary_md = '\\n'.join(summary_lines).strip()\n\n    sources = [\n        {\n            'source_id': 'tool_outputs',\n            'kind': 'tool_outputs',\n            'text': tool_outputs_md,\n            'truncated': tool_outputs_truncated,\n            'max_tool_outputs_chars': max_total_chars,\n        },\n        {'source_id': 'work_summary', 'kind': 'work_summary', 'text': work_summary_md},\n    ]\n    if attachment_ids:\n        sources.append({'source_id': 'attachments_used', 'kind': 'attachments_used', 'artifact_ids': attachment_ids, 'text': 'Attachments used:\\n' + '\\n'.join([f\"- {x}\" for x in attachment_ids])})\n\n    return sources\n"
      }
	    },
	    {
	      "id": "ctx_attachments",
	      "type": "get",
	      "position": {
	        "x": -352.0,
	        "y": 528.0
	      },
	      "data": {
	        "nodeType": "get",
	        "label": "context.attachments",
	        "icon": "&#x1F4E5;",
	        "headerColor": "#3498DB",
	        "inputs": [
	          { "id": "object", "label": "object", "type": "object" },
	          { "id": "key", "label": "key", "type": "string" },
	          { "id": "default", "label": "default", "type": "any" }
	        ],
	        "outputs": [{ "id": "value", "label": "value", "type": "any" }],
	        "pinDefaults": { "key": "attachments", "default": [] }
	      }
	    },
	    {
	      "id": "ctx_min",
	      "type": "make_object",
	      "position": {
	        "x": -128.0,
	        "y": 528.0
	      },
	      "data": {
	        "nodeType": "make_object",
	        "label": "Context (attachments only)",
	        "icon": "{}",
	        "headerColor": "#3498DB",
	        "inputs": [
	          { "id": "attachments", "label": "attachments", "type": "array" }
	        ],
	        "outputs": [{ "id": "result", "label": "result", "type": "object" }]
	      }
	    },
      {
        "id": "kg_attachment_calls",
        "type": "code",
        "position": {
          "x": -352.0,
          "y": 672.0
        },
        "data": {
          "nodeType": "code",
          "label": "KG open active attachments",
          "icon": "&#x1F4CE;",
          "headerColor": "#9B59B6",
          "inputs": [
            { "id": "exec-in", "label": "", "type": "execution" },
            { "id": "input", "label": "attachments", "type": "any" }
          ],
          "outputs": [
            { "id": "exec-out", "label": "", "type": "execution" },
            { "id": "output", "label": "tool_calls", "type": "any" }
          ],
          "functionName": "transform",
          "code": "def transform(_input):\n    items = _input.get('input') if isinstance(_input, dict) else None\n    if not isinstance(items, list) or not items:\n        return []\n\n    out = []\n    for it in items:\n        if not isinstance(it, dict):\n            continue\n        aid = it.get('$artifact') or it.get('artifact_id') or it.get('id')\n        if not isinstance(aid, str) or not aid.strip():\n            continue\n        # max_chars<=0 means \"no artificial cap\" (see open_attachment tool contract).\n        out.append({'name': 'open_attachment', 'arguments': {'artifact_id': aid.strip(), 'start_line': 1, 'end_line': None, 'max_chars': 0}})\n\n    return out\n"
        }
      },
      {
        "id": "kg_open_attachments_allow",
        "type": "literal_array",
        "position": {
          "x": -352.0,
          "y": 784.0
        },
        "data": {
          "nodeType": "literal_array",
          "label": "KG open_attachments allowlist",
          "icon": "[]",
          "headerColor": "#00FFFF",
          "inputs": [],
          "outputs": [{ "id": "value", "label": "value", "type": "array" }],
          "literalValue": ["open_attachment"]
        }
      },
      {
        "id": "kg_open_attachments",
        "type": "tool_calls",
        "position": {
          "x": -128.0,
          "y": 672.0
        },
        "data": {
          "nodeType": "tool_calls",
          "label": "KG open attachments",
          "icon": "&#x1F528;",
          "headerColor": "#16A085",
          "inputs": [
            { "id": "exec-in", "label": "", "type": "execution" },
            { "id": "tool_calls", "label": "tool_calls", "type": "array" },
            { "id": "allowed_tools", "label": "allowed_tools", "type": "array" }
          ],
          "outputs": [
            { "id": "exec-out", "label": "", "type": "execution" },
            { "id": "results", "label": "results", "type": "array" },
            { "id": "success", "label": "success", "type": "boolean" }
          ]
        }
      },
      {
        "id": "kg_attachment_sources",
        "type": "code",
        "position": {
          "x": 96.0,
          "y": 672.0
        },
        "data": {
          "nodeType": "code",
          "label": "KG attachment sources",
          "icon": "&#x1F4C4;",
          "headerColor": "#9B59B6",
          "inputs": [
            { "id": "exec-in", "label": "", "type": "execution" },
            { "id": "input", "label": "open results", "type": "any" }
          ],
          "outputs": [
            { "id": "exec-out", "label": "", "type": "execution" },
            { "id": "output", "label": "sources", "type": "any" }
          ],
          "functionName": "transform",
          "code": "def transform(_input):\n    results = _input.get('input') if isinstance(_input, dict) else None\n    if not isinstance(results, list) or not results:\n        return []\n\n    out = []\n    seen = set()\n\n    def _safe_str(v):\n        return v if isinstance(v, str) else str(v or '')\n\n    for idx, r in enumerate(results, start=1):\n        if not isinstance(r, dict):\n            continue\n        if _safe_str(r.get('name')).strip() != 'open_attachment':\n            continue\n        if r.get('success') is not True:\n            continue\n        o = r.get('output')\n        if not isinstance(o, dict):\n            continue\n        text = o.get('content_text')\n        if not isinstance(text, str) or not text.strip():\n            continue\n        aid = o.get('artifact_id')\n        if not isinstance(aid, str) or not aid.strip():\n            continue\n\n        title = _safe_str(o.get('handle')).strip()\n        base_id = title or aid.strip() or f'attachment-{idx}'\n        base_id = base_id.replace('\\\\', '/').strip().strip('/')\n        base_id = base_id.rsplit('/', 1)[-1] if base_id else f'attachment-{idx}'\n        source_id = f'attachment:{base_id}'\n        if source_id in seen:\n            source_id = f\"{source_id}-{idx}\"\n        seen.add(source_id)\n\n        src = {\n            'source_id': source_id,\n            'kind': 'attachment',\n            'artifact_id': aid.strip(),\n            'title': title if title else None,\n            'text': text,\n        }\n        if o.get('truncated'):\n            src['truncated'] = True\n        ct = o.get('derived_text_content_type') or o.get('content_type')\n        ct = _safe_str(ct).strip()\n        if ct:\n            src['content_type'] = ct\n\n        out.append(src)\n\n    return out\n"
        }
      },
      {
        "id": "kg_sources_merge_input",
        "type": "make_object",
        "position": {
          "x": 352.0,
          "y": 672.0
        },
        "data": {
          "nodeType": "make_object",
          "label": "KG sources merge input",
          "icon": "{}",
          "headerColor": "#3498DB",
          "inputs": [
            { "id": "tool_sources", "label": "tool_sources", "type": "array" },
            { "id": "attachment_sources", "label": "attachment_sources", "type": "array" }
          ],
          "outputs": [{ "id": "result", "label": "result", "type": "object" }]
        }
      },
      {
        "id": "kg_sources_all",
        "type": "code",
        "position": {
          "x": 576.0,
          "y": 672.0
        },
        "data": {
          "nodeType": "code",
          "label": "KG sources (combined)",
          "icon": "&#x1F4DA;",
          "headerColor": "#9B59B6",
          "inputs": [
            { "id": "exec-in", "label": "", "type": "execution" },
            { "id": "input", "label": "sources", "type": "any" }
          ],
          "outputs": [
            { "id": "exec-out", "label": "", "type": "execution" },
            { "id": "output", "label": "sources", "type": "any" }
          ],
          "functionName": "transform",
          "code": "def transform(_input):\n    payload = _input.get('input') if isinstance(_input, dict) else None\n    if not isinstance(payload, dict):\n        payload = {}\n\n    tool_sources = payload.get('tool_sources')\n    attachment_sources = payload.get('attachment_sources')\n\n    out = []\n    seen = set()\n\n    for arr in (tool_sources, attachment_sources):\n        if not isinstance(arr, list):\n            continue\n        for it in arr:\n            if not isinstance(it, dict):\n                continue\n            sid = it.get('source_id')\n            sid2 = sid.strip() if isinstance(sid, str) else ''\n            if sid2 and sid2 in seen:\n                continue\n            if sid2:\n                seen.add(sid2)\n            out.append(dict(it))\n\n    return out\n"
        }
      },
	    {
	      "id": "ingest_input",
	      "type": "make_object",
	      "position": {
        "x": -128.0,
        "y": 240.0
      },
      "data": {
        "nodeType": "make_object",
        "label": "KG ingest input",
        "icon": "{}",
        "headerColor": "#3498DB",
	        "inputs": [
	          {
	            "id": "provider",
            "label": "provider",
            "type": "provider"
          },
          {
            "id": "model",
            "label": "model",
            "type": "model"
          },
          {
            "id": "text",
            "label": "text",
            "type": "string"
          },
          {
            "id": "sources",
            "label": "sources",
            "type": "array"
          },
          {
            "id": "scope",
            "label": "scope",
            "type": "string"
          },
          {
            "id": "domain_focus",
            "label": "domain_focus",
            "type": "string"
          },
	          {
	            "id": "max_out_tokens",
	            "label": "max_out_tokens",
	            "type": "number"
	          },
	          {
	            "id": "context",
	            "label": "context",
	            "type": "object"
	          }
	        ],
	        "outputs": [
	          {
            "id": "result",
            "label": "result",
            "type": "object"
          }
        ]
      }
    },
    {
      "id": "kg_ingest",
      "type": "subflow",
      "position": {
        "x": 128.0,
        "y": 0.0
      },
      "data": {
        "nodeType": "subflow",
        "label": "KG ingest (extract → assert)",
        "icon": "&#x1F4E6;",
        "headerColor": "#00CCCC",
        "inputs": [
          {
            "id": "exec-in",
            "label": "",
            "type": "execution"
          },
          {
            "id": "inherit_context",
            "label": "inherit_context",
            "type": "boolean",
            "description": "When true, seed the child run's context.messages from the parent's active context messages. If the pin is not connected, the node checkbox is used. Default: false."
          },
          {
            "id": "input",
            "label": "input",
            "type": "object"
          }
        ],
        "outputs": [
          {
            "id": "exec-out",
            "label": "",
            "type": "execution"
          },
          {
            "id": "output",
            "label": "output",
            "type": "object"
          }
        ],
        "subflowId": "ltm-ai-kg-ingest-turn",
        "pinDefaults": {
          "inherit_context": false
        }
      }
    },
    {
      "id": "kg_ok",
      "type": "get",
      "position": {
        "x": 352.0,
        "y": 176.0
      },
      "data": {
        "nodeType": "get",
        "label": "KG ok",
        "icon": "&#x1F4E5;",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "object",
            "label": "object",
            "type": "object"
          },
          {
            "id": "key",
            "label": "key",
            "type": "string"
          },
          {
            "id": "default",
            "label": "default",
            "type": "any"
          }
        ],
        "outputs": [
          {
            "id": "value",
            "label": "value",
            "type": "any"
          }
        ],
        "pinDefaults": {
          "key": "ok",
          "default": false
        }
      }
    },
    {
      "id": "kg_count",
      "type": "get",
      "position": {
        "x": 352.0,
        "y": 256.0
      },
      "data": {
        "nodeType": "get",
        "label": "KG count",
        "icon": "&#x1F4E5;",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "object",
            "label": "object",
            "type": "object"
          },
          {
            "id": "key",
            "label": "key",
            "type": "string"
          },
          {
            "id": "default",
            "label": "default",
            "type": "any"
          }
        ],
        "outputs": [
          {
            "id": "value",
            "label": "value",
            "type": "any"
          }
        ],
        "pinDefaults": {
          "key": "count",
          "default": 0
        }
      }
    },
    {
      "id": "kg_ingest_summary",
      "type": "make_object",
      "position": {
        "x": 576.0,
        "y": 224.0
      },
      "data": {
        "nodeType": "make_object",
        "label": "KG ingest summary",
        "icon": "{}",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "ok",
            "label": "ok",
            "type": "boolean"
          },
          {
            "id": "count",
            "label": "count",
            "type": "number"
          }
        ],
        "outputs": [
          {
            "id": "result",
            "label": "result",
            "type": "object"
          }
        ]
      }
    },
    {
      "id": "kg_meta",
      "type": "make_object",
      "position": {
        "x": 800.0,
        "y": 224.0
      },
      "data": {
        "nodeType": "make_object",
        "label": "Meta additions",
        "icon": "{}",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "kg_ingest",
            "label": "kg_ingest",
            "type": "object"
          }
        ],
        "outputs": [
          {
            "id": "result",
            "label": "result",
            "type": "object"
          }
        ]
      }
    },
    {
      "id": "merge_meta",
      "type": "merge",
      "position": {
        "x": 1024.0,
        "y": 224.0
      },
      "data": {
        "nodeType": "merge",
        "label": "Merge meta",
        "icon": "&#x1F517;",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "a",
            "label": "a",
            "type": "object"
          },
          {
            "id": "b",
            "label": "b",
            "type": "object"
          }
        ],
        "outputs": [
          {
            "id": "result",
            "label": "result",
            "type": "object"
          }
        ]
      }
    },
    {
      "id": "success_true",
      "type": "literal_boolean",
      "position": {
        "x": 352.0,
        "y": 352.0
      },
      "data": {
        "nodeType": "literal_boolean",
        "label": "true",
        "icon": "&#x1F7E2;",
        "headerColor": "#00FF00",
        "inputs": [],
        "outputs": [
          {
            "id": "value",
            "label": "value",
            "type": "boolean"
          }
        ],
        "literalValue": true
      }
    },
    {
      "id": "agent_success_coalesce",
      "type": "coalesce",
      "position": {
        "x": 576.0,
        "y": 352.0
      },
      "data": {
        "nodeType": "coalesce",
        "label": "Agent success (default true)",
        "icon": "&#x1F517;",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "a",
            "label": "agent_success",
            "type": "any"
          },
          {
            "id": "b",
            "label": "default",
            "type": "any"
          }
        ],
        "outputs": [
          {
            "id": "result",
            "label": "result",
            "type": "any"
          }
        ]
      }
    },
    {
      "id": "overall_success",
      "type": "and",
      "position": {
        "x": 800.0,
        "y": 352.0
      },
      "data": {
        "nodeType": "and",
        "label": "Overall success",
        "icon": "&#x1F517;",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "a",
            "label": "agent",
            "type": "any"
          },
          {
            "id": "b",
            "label": "kg",
            "type": "any"
          }
        ],
        "outputs": [
          {
            "id": "result",
            "label": "result",
            "type": "boolean"
          }
        ]
      }
    },
    {
      "id": "end",
      "type": "on_flow_end",
      "position": {
        "x": 1280.0,
        "y": 0.0
      },
      "data": {
        "nodeType": "on_flow_end",
        "label": "On Flow End",
        "icon": "&#x23F9;",
        "headerColor": "#C0392B",
        "inputs": [
          {
            "id": "exec-in",
            "label": "",
            "type": "execution"
          },
          {
            "id": "response",
            "label": "response",
            "type": "string"
          },
          {
            "id": "success",
            "label": "success",
            "type": "boolean"
          },
          {
            "id": "meta",
            "label": "meta",
            "type": "object"
          },
          {
            "id": "scratchpad",
            "label": "scratchpad",
            "type": "object"
          }
        ],
        "outputs": []
      }
    }
  ],
  "edges": [
    {
      "id": "e-start-agent-exec",
      "source": "start",
      "sourceHandle": "exec-out",
      "target": "agent",
      "targetHandle": "exec-in",
      "animated": true
    },
    {
      "id": "e-start-agent-provider",
      "source": "start",
      "sourceHandle": "provider",
      "target": "agent",
      "targetHandle": "provider",
      "animated": false
    },
    {
      "id": "e-start-agent-model",
      "source": "start",
      "sourceHandle": "model",
      "target": "agent",
      "targetHandle": "model",
      "animated": false
    },
    {
      "id": "e-start-agent-prompt",
      "source": "start",
      "sourceHandle": "prompt",
      "target": "agent",
      "targetHandle": "prompt",
      "animated": false
    },
    {
      "id": "e-start-agent-system",
      "source": "start",
      "sourceHandle": "system",
      "target": "agent",
      "targetHandle": "system",
      "animated": false
    },
    {
      "id": "e-start-agent-tools",
      "source": "start",
      "sourceHandle": "tools",
      "target": "agent",
      "targetHandle": "tools",
      "animated": false
    },
    {
      "id": "e-start-agent-use-context",
      "source": "start",
      "sourceHandle": "use_context",
      "target": "agent",
      "targetHandle": "use_context",
      "animated": false
    },
    {
      "id": "e-start-agent-context",
      "source": "start",
      "sourceHandle": "context",
      "target": "agent",
      "targetHandle": "context",
      "animated": false
    },
    {
      "id": "e-start-ctx-attachments-object",
      "source": "start",
      "sourceHandle": "context",
      "target": "ctx_attachments",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "e-ctx-attachments-ctx-min-attachments",
      "source": "ctx_attachments",
      "sourceHandle": "value",
      "target": "ctx_min",
      "targetHandle": "attachments",
      "animated": false
    },
    {
      "id": "e-ctx-min-ingest-input-context",
      "source": "ctx_min",
      "sourceHandle": "result",
      "target": "ingest_input",
      "targetHandle": "context",
      "animated": false
    },
    {
      "id": "e-start-agent-max-iterations",
      "source": "start",
      "sourceHandle": "max_iterations",
      "target": "agent",
      "targetHandle": "max_iterations",
      "animated": false
    },
    {
      "id": "e-start-agent-max-in-tokens",
      "source": "start",
      "sourceHandle": "max_in_tokens",
      "target": "agent",
      "targetHandle": "max_in_tokens",
      "animated": false
    },
    {
      "id": "e-start-agent-temperature",
      "source": "start",
      "sourceHandle": "temperature",
      "target": "agent",
      "targetHandle": "temperature",
      "animated": false
    },
    {
      "id": "e-start-agent-seed",
      "source": "start",
      "sourceHandle": "seed",
      "target": "agent",
      "targetHandle": "seed",
      "animated": false
    },
    {
      "id": "e-start-agent-resp-schema",
      "source": "start",
      "sourceHandle": "resp_schema",
      "target": "agent",
      "targetHandle": "resp_schema",
      "animated": false
    },
    {
      "id": "e-start-memory-effective-b",
      "source": "start",
      "sourceHandle": "memory",
      "target": "memory_effective",
      "targetHandle": "b",
      "animated": false
    },
    {
      "id": "e-memory-default-memory-effective-a",
      "source": "memory_default",
      "sourceHandle": "value",
      "target": "memory_effective",
      "targetHandle": "a",
      "animated": false
    },
    {
      "id": "e-memory-effective-agent-memory",
      "source": "memory_effective",
      "sourceHandle": "result",
      "target": "agent",
      "targetHandle": "memory",
      "animated": false
    },
    {
      "id": "e-memory-effective-write-scope-object",
      "source": "memory_effective",
      "sourceHandle": "result",
      "target": "mem_write_scope",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "e-memory-effective-domain-focus-object",
      "source": "memory_effective",
      "sourceHandle": "result",
      "target": "mem_domain_focus",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "e-memory-effective-max-out-tokens-object",
      "source": "memory_effective",
      "sourceHandle": "result",
      "target": "mem_max_out_tokens",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "e-start-turn-vars-prompt",
      "source": "start",
      "sourceHandle": "prompt",
      "target": "turn_vars",
      "targetHandle": "prompt",
      "animated": false
    },
    {
      "id": "e-agent-turn-vars-response",
      "source": "agent",
      "sourceHandle": "response",
      "target": "turn_vars",
      "targetHandle": "response",
      "animated": false
    },
    {
      "id": "e-turn-vars-turn-text",
      "source": "turn_vars",
      "sourceHandle": "result",
      "target": "turn_text",
      "targetHandle": "vars",
      "animated": false
    },
    {
      "id": "e-turn-text-ingest-input-text",
      "source": "turn_text",
      "sourceHandle": "result",
      "target": "ingest_input",
      "targetHandle": "text",
      "animated": false
    },
    {
      "id": "e-start-ingest-input-provider",
      "source": "start",
      "sourceHandle": "provider",
      "target": "ingest_input",
      "targetHandle": "provider",
      "animated": false
    },
    {
      "id": "e-start-ingest-input-model",
      "source": "start",
      "sourceHandle": "model",
      "target": "ingest_input",
      "targetHandle": "model",
      "animated": false
    },
    {
      "id": "e-mem-write-scope-ingest-scope",
      "source": "mem_write_scope",
      "sourceHandle": "value",
      "target": "ingest_input",
      "targetHandle": "scope",
      "animated": false
    },
    {
      "id": "e-mem-domain-focus-ingest-domain-focus",
      "source": "mem_domain_focus",
      "sourceHandle": "value",
      "target": "ingest_input",
      "targetHandle": "domain_focus",
      "animated": false
    },
    {
      "id": "e-mem-max-out-tokens-ingest-max-out-tokens",
      "source": "mem_max_out_tokens",
      "sourceHandle": "value",
      "target": "ingest_input",
      "targetHandle": "max_out_tokens",
      "animated": false
    },
    {
      "id": "e-agent-kg-sources-scratchpad",
      "source": "agent",
      "sourceHandle": "scratchpad",
      "target": "kg_sources",
      "targetHandle": "input",
      "animated": false
    },
    {
      "id": "e-agent-kg-ingest-exec",
      "source": "agent",
      "sourceHandle": "exec-out",
      "target": "kg_sources",
      "targetHandle": "exec-in",
      "animated": true
    },
    {
      "id": "e-ctx-attachments-kg-attachment-calls",
      "source": "ctx_attachments",
      "sourceHandle": "value",
      "target": "kg_attachment_calls",
      "targetHandle": "input",
      "animated": false
    },
    {
      "id": "e-kg-sources-kg-attachment-calls-exec",
      "source": "kg_sources",
      "sourceHandle": "exec-out",
      "target": "kg_attachment_calls",
      "targetHandle": "exec-in",
      "animated": true
    },
    {
      "id": "e-kg-attachment-calls-open-attachments-toolcalls",
      "source": "kg_attachment_calls",
      "sourceHandle": "output",
      "target": "kg_open_attachments",
      "targetHandle": "tool_calls",
      "animated": false
    },
    {
      "id": "e-kg-attachment-calls-open-attachments-exec",
      "source": "kg_attachment_calls",
      "sourceHandle": "exec-out",
      "target": "kg_open_attachments",
      "targetHandle": "exec-in",
      "animated": true
    },
    {
      "id": "e-kg-open-attachments-allow-tools",
      "source": "kg_open_attachments_allow",
      "sourceHandle": "value",
      "target": "kg_open_attachments",
      "targetHandle": "allowed_tools",
      "animated": false
    },
    {
      "id": "e-kg-open-attachments-kg-attachment-sources-input",
      "source": "kg_open_attachments",
      "sourceHandle": "results",
      "target": "kg_attachment_sources",
      "targetHandle": "input",
      "animated": false
    },
    {
      "id": "e-kg-open-attachments-kg-attachment-sources-exec",
      "source": "kg_open_attachments",
      "sourceHandle": "exec-out",
      "target": "kg_attachment_sources",
      "targetHandle": "exec-in",
      "animated": true
    },
    {
      "id": "e-kg-sources-merge-tool-sources",
      "source": "kg_sources",
      "sourceHandle": "output",
      "target": "kg_sources_merge_input",
      "targetHandle": "tool_sources",
      "animated": false
    },
    {
      "id": "e-kg-attachment-sources-merge-attachment-sources",
      "source": "kg_attachment_sources",
      "sourceHandle": "output",
      "target": "kg_sources_merge_input",
      "targetHandle": "attachment_sources",
      "animated": false
    },
    {
      "id": "e-kg-sources-merge-input-kg-sources-all-input",
      "source": "kg_sources_merge_input",
      "sourceHandle": "result",
      "target": "kg_sources_all",
      "targetHandle": "input",
      "animated": false
    },
    {
      "id": "e-kg-attachment-sources-kg-sources-all-exec",
      "source": "kg_attachment_sources",
      "sourceHandle": "exec-out",
      "target": "kg_sources_all",
      "targetHandle": "exec-in",
      "animated": true
    },
    {
      "id": "e-kg-sources-all-ingest-input-sources",
      "source": "kg_sources_all",
      "sourceHandle": "output",
      "target": "ingest_input",
      "targetHandle": "sources",
      "animated": false
    },
    {
      "id": "e-kg-sources-all-kg-ingest-exec",
      "source": "kg_sources_all",
      "sourceHandle": "exec-out",
      "target": "kg_ingest",
      "targetHandle": "exec-in",
      "animated": true
    },
    {
      "id": "e-ingest-input-kg-ingest-input",
      "source": "ingest_input",
      "sourceHandle": "result",
      "target": "kg_ingest",
      "targetHandle": "input",
      "animated": false
    },
    {
      "id": "e-kg-ingest-kg-ok-object",
      "source": "kg_ingest",
      "sourceHandle": "output",
      "target": "kg_ok",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "e-kg-ingest-kg-count-object",
      "source": "kg_ingest",
      "sourceHandle": "output",
      "target": "kg_count",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "e-kg-ok-summary-ok",
      "source": "kg_ok",
      "sourceHandle": "value",
      "target": "kg_ingest_summary",
      "targetHandle": "ok",
      "animated": false
    },
    {
      "id": "e-kg-count-summary-count",
      "source": "kg_count",
      "sourceHandle": "value",
      "target": "kg_ingest_summary",
      "targetHandle": "count",
      "animated": false
    },
    {
      "id": "e-kg-summary-kg-meta",
      "source": "kg_ingest_summary",
      "sourceHandle": "result",
      "target": "kg_meta",
      "targetHandle": "kg_ingest",
      "animated": false
    },
    {
      "id": "e-agent-meta-merge-a",
      "source": "agent",
      "sourceHandle": "meta",
      "target": "merge_meta",
      "targetHandle": "a",
      "animated": false
    },
    {
      "id": "e-kg-meta-merge-b",
      "source": "kg_meta",
      "sourceHandle": "result",
      "target": "merge_meta",
      "targetHandle": "b",
      "animated": false
    },
    {
      "id": "e-agent-success-coalesce-a",
      "source": "agent",
      "sourceHandle": "success",
      "target": "agent_success_coalesce",
      "targetHandle": "a",
      "animated": false
    },
    {
      "id": "e-success-true-coalesce-b",
      "source": "success_true",
      "sourceHandle": "value",
      "target": "agent_success_coalesce",
      "targetHandle": "b",
      "animated": false
    },
    {
      "id": "e-agent-success-overall-a",
      "source": "agent_success_coalesce",
      "sourceHandle": "result",
      "target": "overall_success",
      "targetHandle": "a",
      "animated": false
    },
    {
      "id": "e-kg-ok-overall-b",
      "source": "kg_ok",
      "sourceHandle": "value",
      "target": "overall_success",
      "targetHandle": "b",
      "animated": false
    },
    {
      "id": "e-kg-ingest-end-exec",
      "source": "kg_ingest",
      "sourceHandle": "exec-out",
      "target": "end",
      "targetHandle": "exec-in",
      "animated": true
    },
    {
      "id": "e-agent-end-response",
      "source": "agent",
      "sourceHandle": "response",
      "target": "end",
      "targetHandle": "response",
      "animated": false
    },
    {
      "id": "e-overall-success-end-success",
      "source": "overall_success",
      "sourceHandle": "result",
      "target": "end",
      "targetHandle": "success",
      "animated": false
    },
    {
      "id": "e-merge-meta-end-meta",
      "source": "merge_meta",
      "sourceHandle": "result",
      "target": "end",
      "targetHandle": "meta",
      "animated": false
    },
    {
      "id": "e-agent-end-scratchpad",
      "source": "agent",
      "sourceHandle": "scratchpad",
      "target": "end",
      "targetHandle": "scratchpad",
      "animated": false
    }
  ],
  "entryNode": "start"
}
