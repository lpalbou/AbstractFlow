{
  "id": "ltm-ai-kg-map-to-active",
  "name": "ltm-ai-kg-map-to-active",
  "description": "Query AbstractMemory triples and map results into a compact, token-budgeted Active Memory text block (\"memory packets\") suitable for injection into an LLM system prompt.",
  "interfaces": [],
  "nodes": [
    {
      "id": "node-1",
      "type": "on_flow_start",
      "position": {
        "x": 96.0,
        "y": 96.0
      },
      "data": {
        "nodeType": "on_flow_start",
        "label": "Start",
        "icon": "&#x1F3C1;",
        "headerColor": "#C0392B",
        "inputs": [],
        "outputs": [
          {
            "id": "exec-out",
            "label": "",
            "type": "execution"
          },
          {
            "id": "query_text",
            "label": "query_text",
            "type": "string"
          },
          {
            "id": "scope",
            "label": "scope",
            "type": "string"
          },
          {
            "id": "limit",
            "label": "limit",
            "type": "number"
          },
          {
            "id": "max_input_tokens",
            "label": "max_input_tokens",
            "type": "number"
          },
          {
            "id": "model",
            "label": "model",
            "type": "model"
          }
        ],
        "pinDefaults": {
          "scope": "session",
          "limit": 80,
          "max_input_tokens": 2000,
          "model": "qwen/qwen3-next-80b"
        }
      }
    },
    {
      "id": "node-2",
      "type": "memory_kg_query",
      "position": {
        "x": 384.0,
        "y": 96.0
      },
      "data": {
        "nodeType": "memory_kg_query",
        "label": "KG query",
        "icon": "&#x1F50E;",
        "headerColor": "#8E44AD",
        "inputs": [
          {
            "id": "exec-in",
            "label": "",
            "type": "execution"
          },
          {
            "id": "query_text",
            "label": "query_text",
            "type": "string"
          },
          {
            "id": "subject",
            "label": "subject",
            "type": "string"
          },
          {
            "id": "predicate",
            "label": "predicate",
            "type": "string"
          },
          {
            "id": "object",
            "label": "object",
            "type": "string"
          },
          {
            "id": "scope",
            "label": "scope",
            "type": "string"
          },
          {
            "id": "limit",
            "label": "limit",
            "type": "number"
          }
        ],
        "outputs": [
          {
            "id": "exec-out",
            "label": "",
            "type": "execution"
          },
          {
            "id": "items",
            "label": "items",
            "type": "array"
          },
          {
            "id": "count",
            "label": "count",
            "type": "number"
          },
          {
            "id": "ok",
            "label": "ok",
            "type": "boolean"
          },
          {
            "id": "raw",
            "label": "raw",
            "type": "object"
          }
        ]
      }
    },
    {
      "id": "node-3",
      "type": "literal_json",
      "position": {
        "x": 640.0,
        "y": 176.0
      },
      "data": {
        "nodeType": "literal_json",
        "label": "Input",
        "icon": "{}",
        "headerColor": "#00FFFF",
        "inputs": [],
        "outputs": [
          {
            "id": "value",
            "label": "value",
            "type": "object"
          }
        ],
        "literalValue": {}
      }
    },
    {
      "id": "node-4",
      "type": "set",
      "position": {
        "x": 896.0,
        "y": 96.0
      },
      "data": {
        "nodeType": "set",
        "label": "Set items",
        "icon": "&#x1F4E4;",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "object",
            "label": "object",
            "type": "object"
          },
          {
            "id": "key",
            "label": "key",
            "type": "string"
          },
          {
            "id": "value",
            "label": "value",
            "type": "any"
          }
        ],
        "outputs": [
          {
            "id": "result",
            "label": "result",
            "type": "object"
          }
        ],
        "pinDefaults": {
          "key": "items"
        }
      }
    },
    {
      "id": "node-5",
      "type": "set",
      "position": {
        "x": 1152.0,
        "y": 96.0
      },
      "data": {
        "nodeType": "set",
        "label": "Set max_input_tokens",
        "icon": "&#x1F4E4;",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "object",
            "label": "object",
            "type": "object"
          },
          {
            "id": "key",
            "label": "key",
            "type": "string"
          },
          {
            "id": "value",
            "label": "value",
            "type": "any"
          }
        ],
        "outputs": [
          {
            "id": "result",
            "label": "result",
            "type": "object"
          }
        ],
        "pinDefaults": {
          "key": "max_input_tokens"
        }
      }
    },
    {
      "id": "node-6",
      "type": "set",
      "position": {
        "x": 1408.0,
        "y": 96.0
      },
      "data": {
        "nodeType": "set",
        "label": "Set model",
        "icon": "&#x1F4E4;",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "object",
            "label": "object",
            "type": "object"
          },
          {
            "id": "key",
            "label": "key",
            "type": "string"
          },
          {
            "id": "value",
            "label": "value",
            "type": "any"
          }
        ],
        "outputs": [
          {
            "id": "result",
            "label": "result",
            "type": "object"
          }
        ],
        "pinDefaults": {
          "key": "model"
        }
      }
    },
    {
      "id": "node-7",
      "type": "set",
      "position": {
        "x": 1664.0,
        "y": 96.0
      },
      "data": {
        "nodeType": "set",
        "label": "Set scope",
        "icon": "&#x1F4E4;",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "object",
            "label": "object",
            "type": "object"
          },
          {
            "id": "key",
            "label": "key",
            "type": "string"
          },
          {
            "id": "value",
            "label": "value",
            "type": "any"
          }
        ],
        "outputs": [
          {
            "id": "result",
            "label": "result",
            "type": "object"
          }
        ],
        "pinDefaults": {
          "key": "scope"
        }
      }
    },
    {
      "id": "node-8",
      "type": "code",
      "position": {
        "x": 1936.0,
        "y": 96.0
      },
      "data": {
        "nodeType": "code",
        "label": "Packetize + pack",
        "icon": "&#x1F40D;",
        "headerColor": "#9B59B6",
        "inputs": [
          {
            "id": "exec-in",
            "label": "",
            "type": "execution"
          },
          {
            "id": "input",
            "label": "input",
            "type": "any"
          }
        ],
        "outputs": [
          {
            "id": "exec-out",
            "label": "",
            "type": "execution"
          },
          {
            "id": "output",
            "label": "output",
            "type": "any"
          }
        ],
        "codeBody": "def _coerce_int(v, default):\n    try:\n        if v is None or v == \"\":\n            return int(default)\n        if isinstance(v, bool):\n            return int(default)\n        return int(float(v))\n    except Exception:\n        return int(default)\n\n\ndef _clean_str(v):\n    if v is None:\n        return \"\"\n    s = v if isinstance(v, str) else str(v)\n    return s.strip()\n\n\ndef _packet_for(item):\n    if not isinstance(item, dict):\n        return None\n    s = _clean_str(item.get(\"subject\"))\n    p = _clean_str(item.get(\"predicate\"))\n    o = _clean_str(item.get(\"object\"))\n    if not (s and p and o):\n        return None\n\n    prov = item.get(\"provenance\") if isinstance(item.get(\"provenance\"), dict) else {}\n    span_id = _clean_str(prov.get(\"span_id\"))\n\n    statement = f\"{s} —{p}→ {o}\"\n    pkt = {\n        \"statement\": statement,\n        \"subject\": s,\n        \"predicate\": p,\n        \"object\": o,\n        \"observed_at\": _clean_str(item.get(\"observed_at\")),\n        \"scope\": _clean_str(item.get(\"scope\")),\n        \"owner_id\": _clean_str(item.get(\"owner_id\")),\n        \"span_id\": span_id,\n        \"writer_run_id\": _clean_str(prov.get(\"writer_run_id\")),\n        \"writer_workflow_id\": _clean_str(prov.get(\"writer_workflow_id\")),\n    }\n    # drop empties for compactness\n    return {k: v for k, v in pkt.items() if v not in (None, \"\")}\n\n\ndef transform(input):\n    d = input if isinstance(input, dict) else {}\n    items = d.get(\"items\") if isinstance(d.get(\"items\"), list) else []\n    scope = _clean_str(d.get(\"scope\")) or \"session\"\n    model = _clean_str(d.get(\"model\")) or None\n    max_input_tokens = _coerce_int(d.get(\"max_input_tokens\"), 2000)\n\n    # Best-effort token estimator (imports are disallowed in VisualFlow code nodes).\n    def estimate_tokens(text, model=None):\n        s = str(text or \"\")\n        return 0 if not s else max(1, int(len(s) / 4))\n\n    header = [\n        \"## KG ACTIVE MEMORY\",\n        f\"(scope={scope}; newest-first; budget={max_input_tokens} max_input_tokens)\",\n        \"\",\n    ]\n\n    lines = list(header)\n    kept_packets = []\n    tokens = estimate_tokens(\"\\n\".join(lines), model=model)\n\n    for raw in items:\n        pkt = _packet_for(raw)\n        if pkt is None:\n            continue\n\n        ts = pkt.get(\"observed_at\") or \"\"\n        prefix = f\"[{ts}] \" if ts else \"\"\n\n        line = f\"- {prefix}{pkt.get('statement','')}\"\n        span_id = pkt.get(\"span_id\")\n        if span_id:\n            line = f\"{line} (span:{span_id})\"\n\n        add = estimate_tokens(\"\\n\" + line, model=model)\n        if max_input_tokens > 0 and tokens + add > max_input_tokens:\n            break\n\n        lines.append(line)\n        kept_packets.append(pkt)\n        tokens += add\n\n    if not kept_packets:\n        return {\n            \"ok\": True,\n            \"count\": 0,\n            \"dropped\": max(0, len(items)),\n            \"estimated_tokens\": 0,\n            \"packets\": [],\n            \"active_memory_text\": \"\",\n            \"version\": 1,\n        }\n\n    active_memory_text = \"\\n\".join(lines).strip()\n    return {\n        \"ok\": True,\n        \"count\": len(kept_packets),\n        \"dropped\": max(0, len(items) - len(kept_packets)),\n        \"estimated_tokens\": int(tokens),\n        \"packets\": kept_packets,\n        \"active_memory_text\": active_memory_text,\n        \"version\": 1,\n    }\n",
        "code": "def _coerce_int(v, default):\n    try:\n        if v is None or v == \"\":\n            return int(default)\n        if isinstance(v, bool):\n            return int(default)\n        return int(float(v))\n    except Exception:\n        return int(default)\n\n\ndef _clean_str(v):\n    if v is None:\n        return \"\"\n    s = v if isinstance(v, str) else str(v)\n    return s.strip()\n\n\ndef _packet_for(item):\n    if not isinstance(item, dict):\n        return None\n    s = _clean_str(item.get(\"subject\"))\n    p = _clean_str(item.get(\"predicate\"))\n    o = _clean_str(item.get(\"object\"))\n    if not (s and p and o):\n        return None\n\n    prov = item.get(\"provenance\") if isinstance(item.get(\"provenance\"), dict) else {}\n    span_id = _clean_str(prov.get(\"span_id\"))\n\n    statement = f\"{s} —{p}→ {o}\"\n    pkt = {\n        \"statement\": statement,\n        \"subject\": s,\n        \"predicate\": p,\n        \"object\": o,\n        \"observed_at\": _clean_str(item.get(\"observed_at\")),\n        \"scope\": _clean_str(item.get(\"scope\")),\n        \"owner_id\": _clean_str(item.get(\"owner_id\")),\n        \"span_id\": span_id,\n        \"writer_run_id\": _clean_str(prov.get(\"writer_run_id\")),\n        \"writer_workflow_id\": _clean_str(prov.get(\"writer_workflow_id\")),\n    }\n    # drop empties for compactness\n    return {k: v for k, v in pkt.items() if v not in (None, \"\")}\n\n\ndef transform(input):\n    d = input if isinstance(input, dict) else {}\n    items = d.get(\"items\") if isinstance(d.get(\"items\"), list) else []\n    scope = _clean_str(d.get(\"scope\")) or \"session\"\n    model = _clean_str(d.get(\"model\")) or None\n    max_input_tokens = _coerce_int(d.get(\"max_input_tokens\"), 2000)\n\n    # Best-effort token estimator (imports are disallowed in VisualFlow code nodes).\n    def estimate_tokens(text, model=None):\n        s = str(text or \"\")\n        return 0 if not s else max(1, int(len(s) / 4))\n\n    header = [\n        \"## KG ACTIVE MEMORY\",\n        f\"(scope={scope}; newest-first; budget={max_input_tokens} max_input_tokens)\",\n        \"\",\n    ]\n\n    lines = list(header)\n    kept_packets = []\n    tokens = estimate_tokens(\"\\n\".join(lines), model=model)\n\n    for raw in items:\n        pkt = _packet_for(raw)\n        if pkt is None:\n            continue\n\n        ts = pkt.get(\"observed_at\") or \"\"\n        prefix = f\"[{ts}] \" if ts else \"\"\n\n        line = f\"- {prefix}{pkt.get('statement','')}\"\n        span_id = pkt.get(\"span_id\")\n        if span_id:\n            line = f\"{line} (span:{span_id})\"\n\n        add = estimate_tokens(\"\\n\" + line, model=model)\n        if max_input_tokens > 0 and tokens + add > max_input_tokens:\n            break\n\n        lines.append(line)\n        kept_packets.append(pkt)\n        tokens += add\n\n    if not kept_packets:\n        return {\n            \"ok\": True,\n            \"count\": 0,\n            \"dropped\": max(0, len(items)),\n            \"estimated_tokens\": 0,\n            \"packets\": [],\n            \"active_memory_text\": \"\",\n            \"version\": 1,\n        }\n\n    active_memory_text = \"\\n\".join(lines).strip()\n    return {\n        \"ok\": True,\n        \"count\": len(kept_packets),\n        \"dropped\": max(0, len(items) - len(kept_packets)),\n        \"estimated_tokens\": int(tokens),\n        \"packets\": kept_packets,\n        \"active_memory_text\": active_memory_text,\n        \"version\": 1,\n    }\n",
        "functionName": "transform"
      }
    },
    {
      "id": "node-9",
      "type": "get",
      "position": {
        "x": 2224.0,
        "y": 48.0
      },
      "data": {
        "nodeType": "get",
        "label": "Get active_memory_text",
        "icon": "&#x1F4E5;",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "object",
            "label": "object",
            "type": "object"
          },
          {
            "id": "key",
            "label": "key",
            "type": "string"
          },
          {
            "id": "default",
            "label": "default",
            "type": "any"
          }
        ],
        "outputs": [
          {
            "id": "value",
            "label": "value",
            "type": "any"
          }
        ],
        "pinDefaults": {
          "key": "active_memory_text",
          "default": ""
        }
      }
    },
    {
      "id": "node-10",
      "type": "get",
      "position": {
        "x": 2224.0,
        "y": 112.0
      },
      "data": {
        "nodeType": "get",
        "label": "Get packets",
        "icon": "&#x1F4E5;",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "object",
            "label": "object",
            "type": "object"
          },
          {
            "id": "key",
            "label": "key",
            "type": "string"
          },
          {
            "id": "default",
            "label": "default",
            "type": "any"
          }
        ],
        "outputs": [
          {
            "id": "value",
            "label": "value",
            "type": "any"
          }
        ],
        "pinDefaults": {
          "key": "packets",
          "default": []
        }
      }
    },
    {
      "id": "node-11",
      "type": "get",
      "position": {
        "x": 2224.0,
        "y": 176.0
      },
      "data": {
        "nodeType": "get",
        "label": "Get count",
        "icon": "&#x1F4E5;",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "object",
            "label": "object",
            "type": "object"
          },
          {
            "id": "key",
            "label": "key",
            "type": "string"
          },
          {
            "id": "default",
            "label": "default",
            "type": "any"
          }
        ],
        "outputs": [
          {
            "id": "value",
            "label": "value",
            "type": "any"
          }
        ],
        "pinDefaults": {
          "key": "count",
          "default": 0
        }
      }
    },
    {
      "id": "node-12",
      "type": "get",
      "position": {
        "x": 2224.0,
        "y": 240.0
      },
      "data": {
        "nodeType": "get",
        "label": "Get dropped",
        "icon": "&#x1F4E5;",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "object",
            "label": "object",
            "type": "object"
          },
          {
            "id": "key",
            "label": "key",
            "type": "string"
          },
          {
            "id": "default",
            "label": "default",
            "type": "any"
          }
        ],
        "outputs": [
          {
            "id": "value",
            "label": "value",
            "type": "any"
          }
        ],
        "pinDefaults": {
          "key": "dropped",
          "default": 0
        }
      }
    },
    {
      "id": "node-13",
      "type": "get",
      "position": {
        "x": 2224.0,
        "y": 304.0
      },
      "data": {
        "nodeType": "get",
        "label": "Get estimated_tokens",
        "icon": "&#x1F4E5;",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "object",
            "label": "object",
            "type": "object"
          },
          {
            "id": "key",
            "label": "key",
            "type": "string"
          },
          {
            "id": "default",
            "label": "default",
            "type": "any"
          }
        ],
        "outputs": [
          {
            "id": "value",
            "label": "value",
            "type": "any"
          }
        ],
        "pinDefaults": {
          "key": "estimated_tokens",
          "default": 0
        }
      }
    },
    {
      "id": "node-14",
      "type": "get",
      "position": {
        "x": 2224.0,
        "y": 368.0
      },
      "data": {
        "nodeType": "get",
        "label": "Get ok",
        "icon": "&#x1F4E5;",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "object",
            "label": "object",
            "type": "object"
          },
          {
            "id": "key",
            "label": "key",
            "type": "string"
          },
          {
            "id": "default",
            "label": "default",
            "type": "any"
          }
        ],
        "outputs": [
          {
            "id": "value",
            "label": "value",
            "type": "any"
          }
        ],
        "pinDefaults": {
          "key": "ok",
          "default": false
        }
      }
    },
    {
      "id": "node-15",
      "type": "on_flow_end",
      "position": {
        "x": 2496.0,
        "y": 96.0
      },
      "data": {
        "nodeType": "on_flow_end",
        "label": "End",
        "icon": "&#x23F9;",
        "headerColor": "#C0392B",
        "inputs": [
          {
            "id": "exec-in",
            "label": "",
            "type": "execution"
          },
          {
            "id": "active_memory_text",
            "label": "active_memory_text",
            "type": "string"
          },
          {
            "id": "packets",
            "label": "packets",
            "type": "array"
          },
          {
            "id": "count",
            "label": "count",
            "type": "number"
          },
          {
            "id": "dropped",
            "label": "dropped",
            "type": "number"
          },
          {
            "id": "estimated_tokens",
            "label": "estimated_tokens",
            "type": "number"
          },
          {
            "id": "ok",
            "label": "ok",
            "type": "boolean"
          }
        ],
        "outputs": []
      }
    }
  ],
  "edges": [
    {
      "id": "edge-1",
      "source": "node-1",
      "sourceHandle": "exec-out",
      "target": "node-2",
      "targetHandle": "exec-in",
      "animated": true
    },
    {
      "id": "edge-2",
      "source": "node-1",
      "sourceHandle": "query_text",
      "target": "node-2",
      "targetHandle": "query_text",
      "animated": false
    },
    {
      "id": "edge-3",
      "source": "node-1",
      "sourceHandle": "scope",
      "target": "node-2",
      "targetHandle": "scope",
      "animated": false
    },
    {
      "id": "edge-4",
      "source": "node-1",
      "sourceHandle": "limit",
      "target": "node-2",
      "targetHandle": "limit",
      "animated": false
    },
    {
      "id": "edge-5",
      "source": "node-3",
      "sourceHandle": "value",
      "target": "node-4",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-6",
      "source": "node-2",
      "sourceHandle": "items",
      "target": "node-4",
      "targetHandle": "value",
      "animated": false
    },
    {
      "id": "edge-7",
      "source": "node-4",
      "sourceHandle": "result",
      "target": "node-5",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-8",
      "source": "node-1",
      "sourceHandle": "max_input_tokens",
      "target": "node-5",
      "targetHandle": "value",
      "animated": false
    },
    {
      "id": "edge-9",
      "source": "node-5",
      "sourceHandle": "result",
      "target": "node-6",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-10",
      "source": "node-1",
      "sourceHandle": "model",
      "target": "node-6",
      "targetHandle": "value",
      "animated": false
    },
    {
      "id": "edge-11",
      "source": "node-6",
      "sourceHandle": "result",
      "target": "node-7",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-12",
      "source": "node-1",
      "sourceHandle": "scope",
      "target": "node-7",
      "targetHandle": "value",
      "animated": false
    },
    {
      "id": "edge-13",
      "source": "node-2",
      "sourceHandle": "exec-out",
      "target": "node-8",
      "targetHandle": "exec-in",
      "animated": true
    },
    {
      "id": "edge-14",
      "source": "node-7",
      "sourceHandle": "result",
      "target": "node-8",
      "targetHandle": "input",
      "animated": false
    },
    {
      "id": "edge-15",
      "source": "node-8",
      "sourceHandle": "output",
      "target": "node-9",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-16",
      "source": "node-8",
      "sourceHandle": "output",
      "target": "node-10",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-17",
      "source": "node-8",
      "sourceHandle": "output",
      "target": "node-11",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-18",
      "source": "node-8",
      "sourceHandle": "output",
      "target": "node-12",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-19",
      "source": "node-8",
      "sourceHandle": "output",
      "target": "node-13",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-20",
      "source": "node-8",
      "sourceHandle": "output",
      "target": "node-14",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-21",
      "source": "node-9",
      "sourceHandle": "value",
      "target": "node-15",
      "targetHandle": "active_memory_text",
      "animated": false
    },
    {
      "id": "edge-22",
      "source": "node-10",
      "sourceHandle": "value",
      "target": "node-15",
      "targetHandle": "packets",
      "animated": false
    },
    {
      "id": "edge-23",
      "source": "node-11",
      "sourceHandle": "value",
      "target": "node-15",
      "targetHandle": "count",
      "animated": false
    },
    {
      "id": "edge-24",
      "source": "node-12",
      "sourceHandle": "value",
      "target": "node-15",
      "targetHandle": "dropped",
      "animated": false
    },
    {
      "id": "edge-25",
      "source": "node-13",
      "sourceHandle": "value",
      "target": "node-15",
      "targetHandle": "estimated_tokens",
      "animated": false
    },
    {
      "id": "edge-26",
      "source": "node-14",
      "sourceHandle": "value",
      "target": "node-15",
      "targetHandle": "ok",
      "animated": false
    },
    {
      "id": "edge-27",
      "source": "node-8",
      "sourceHandle": "exec-out",
      "target": "node-15",
      "targetHandle": "exec-in",
      "animated": true
    }
  ],
  "entryNode": "node-1"
}
