{
  "id": "ltm-ai-kg-ingest-turn",
  "name": "ltm-ai-kg-ingest-turn",
  "description": "Extract triples from a turn (or any text fragment) and assert them into AbstractMemory via the runtime-owned memory_kg_assert effect. Designed to be composed into ltm-ai-chat or scheduled maintenance workflows.",
  "interfaces": [],
  "nodes": [
    {
      "id": "node-1",
      "type": "on_flow_start",
      "position": {
        "x": 96.0,
        "y": 128.0
      },
      "data": {
        "nodeType": "on_flow_start",
        "label": "Start",
        "icon": "&#x1F3C1;",
        "headerColor": "#C0392B",
        "inputs": [],
        "outputs": [
          {
            "id": "exec-out",
            "label": "",
            "type": "execution"
          },
          {
            "id": "provider",
            "label": "provider",
            "type": "provider"
          },
          {
            "id": "model",
            "label": "model",
            "type": "model"
          },
          {
            "id": "text",
            "label": "text",
            "type": "string"
          },
          {
            "id": "scope",
            "label": "scope",
            "type": "string"
          },
          {
            "id": "span_id",
            "label": "span_id",
            "type": "string"
          },
          {
            "id": "domain_focus",
            "label": "domain_focus",
            "type": "string"
          },
          {
            "id": "max_out_tokens",
            "label": "max_out_tokens",
            "type": "number"
          },
          {
            "id": "extraction_profile",
            "label": "extraction_profile",
            "type": "object"
          },
          {
            "id": "sources",
            "label": "sources",
            "type": "array"
          }
        ],
        "pinDefaults": {
          "provider": "lmstudio",
          "model": "qwen/qwen3-next-80b",
          "scope": "session",
          "domain_focus": "software / agents / memory systems",
          "max_out_tokens": 2000,
          "extraction_profile": {
            "persona_id": "default",
            "persona_version": "v1",
            "persona_summary": "Autonomous AI assistant aligned with AI–human partnership. Truthful, helpful, and efficient; preserves grounded commitments, preferences, definitions, and key concepts.",
            "values": ["truthfulness", "collaboration", "clarity", "efficiency"],
            "purposes": ["help humans accomplish tasks", "build clean, simple, efficient systems", "maintain continuity via grounded memory"],
            "memory_priorities": ["commitments", "preferences", "relationships", "definitions", "key concepts", "decisions"],
            "policy_version": "kg_extract_persona_v1"
          },
          "sources": []
        }
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-2",
      "type": "literal_json",
      "position": {
        "x": 96.0,
        "y": 336.0
      },
      "data": {
        "nodeType": "literal_json",
        "label": "Subflow input",
        "icon": "{}",
        "headerColor": "#00FFFF",
        "inputs": [],
        "outputs": [
          {
            "id": "value",
            "label": "value",
            "type": "object"
          }
        ],
        "literalValue": {}
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-3",
      "type": "set",
      "position": {
        "x": 320.0,
        "y": 288.0
      },
      "data": {
        "nodeType": "set",
        "label": "Set provider",
        "icon": "&#x1F4E4;",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "object",
            "label": "object",
            "type": "object"
          },
          {
            "id": "key",
            "label": "key",
            "type": "string"
          },
          {
            "id": "value",
            "label": "value",
            "type": "any"
          }
        ],
        "outputs": [
          {
            "id": "result",
            "label": "result",
            "type": "object"
          }
        ],
        "pinDefaults": {
          "key": "provider"
        }
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-4",
      "type": "set",
      "position": {
        "x": 560.0,
        "y": 288.0
      },
      "data": {
        "nodeType": "set",
        "label": "Set model",
        "icon": "&#x1F4E4;",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "object",
            "label": "object",
            "type": "object"
          },
          {
            "id": "key",
            "label": "key",
            "type": "string"
          },
          {
            "id": "value",
            "label": "value",
            "type": "any"
          }
        ],
        "outputs": [
          {
            "id": "result",
            "label": "result",
            "type": "object"
          }
        ],
        "pinDefaults": {
          "key": "model"
        }
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-5",
      "type": "set",
      "position": {
        "x": 800.0,
        "y": 288.0
      },
      "data": {
        "nodeType": "set",
        "label": "Set text",
        "icon": "&#x1F4E4;",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "object",
            "label": "object",
            "type": "object"
          },
          {
            "id": "key",
            "label": "key",
            "type": "string"
          },
          {
            "id": "value",
            "label": "value",
            "type": "any"
          }
        ],
        "outputs": [
          {
            "id": "result",
            "label": "result",
            "type": "object"
          }
        ],
        "pinDefaults": {
          "key": "text"
        }
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-6",
      "type": "set",
      "position": {
        "x": 1040.0,
        "y": 288.0
      },
      "data": {
        "nodeType": "set",
        "label": "Set domain_focus",
        "icon": "&#x1F4E4;",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "object",
            "label": "object",
            "type": "object"
          },
          {
            "id": "key",
            "label": "key",
            "type": "string"
          },
          {
            "id": "value",
            "label": "value",
            "type": "any"
          }
        ],
        "outputs": [
          {
            "id": "result",
            "label": "result",
            "type": "object"
          }
        ],
        "pinDefaults": {
          "key": "domain_focus"
        }
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-11",
      "type": "set",
      "position": {
        "x": 1280.0,
        "y": 288.0
      },
      "data": {
        "nodeType": "set",
        "label": "Set max_out_tokens",
        "icon": "&#x1F4E4;",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "object",
            "label": "object",
            "type": "object"
          },
          {
            "id": "key",
            "label": "key",
            "type": "string"
          },
          {
            "id": "value",
            "label": "value",
            "type": "any"
          }
        ],
        "outputs": [
          {
            "id": "result",
            "label": "result",
            "type": "object"
          }
        ],
        "pinDefaults": {
          "key": "max_out_tokens"
        }
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-18",
      "type": "set",
      "position": { "x": 1520.0, "y": 288.0 },
      "data": {
        "nodeType": "set",
        "label": "Set extraction_profile",
        "icon": "&#x1F4E4;",
        "headerColor": "#3498DB",
        "inputs": [
          { "id": "object", "label": "object", "type": "object" },
          { "id": "key", "label": "key", "type": "string" },
          { "id": "value", "label": "value", "type": "any" }
        ],
        "outputs": [{ "id": "result", "label": "result", "type": "object" }],
        "pinDefaults": { "key": "extraction_profile" }
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-27",
      "type": "set",
      "position": { "x": 1520.0, "y": 352.0 },
      "data": {
        "nodeType": "set",
        "label": "Set sources",
        "icon": "&#x1F4E4;",
        "headerColor": "#3498DB",
        "inputs": [
          { "id": "object", "label": "object", "type": "object" },
          { "id": "key", "label": "key", "type": "string" },
          { "id": "value", "label": "value", "type": "any" }
        ],
        "outputs": [{ "id": "result", "label": "result", "type": "object" }],
        "pinDefaults": { "key": "sources" }
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-28",
      "type": "code",
      "position": { "x": 1760.0, "y": 288.0 },
      "data": {
        "nodeType": "code",
        "label": "Build evidence bundle",
        "icon": "&#x1F40D;",
        "headerColor": "#9B59B6",
        "inputs": [
          { "id": "exec-in", "label": "", "type": "execution" },
          { "id": "input", "label": "input", "type": "any" }
        ],
        "outputs": [
          { "id": "exec-out", "label": "", "type": "execution" },
          { "id": "output", "label": "output", "type": "any" }
        ],
        "functionName": "transform",
        "code": "def transform(_input):\n    payload = _input.get('input') if isinstance(_input, dict) else None\n    if not isinstance(payload, dict):\n        payload = {}\n\n    base_text = payload.get('text', '')\n    if not isinstance(base_text, str):\n        base_text = str(base_text or '')\n\n    domain_focus = payload.get('domain_focus', '')\n    if not isinstance(domain_focus, str):\n        domain_focus = str(domain_focus or '')\n\n    # Keep turn-level extraction bounded: the transcript is always included in full,\n    # but non-transcript sources are capped so large attachments don't dominate.\n    max_bundle_chars = payload.get('max_bundle_chars')\n    if max_bundle_chars is None:\n        max_bundle_chars = payload.get('kg_max_bundle_chars')\n    try:\n        max_bundle_chars = int(max_bundle_chars) if max_bundle_chars is not None else 60000\n    except Exception:\n        max_bundle_chars = 60000\n\n    max_source_chars = payload.get('max_source_chars')\n    if max_source_chars is None:\n        max_source_chars = payload.get('kg_max_source_chars')\n    try:\n        max_source_chars = int(max_source_chars) if max_source_chars is not None else 12000\n    except Exception:\n        max_source_chars = 12000\n\n    raw_sources = payload.get('sources', [])\n    if not isinstance(raw_sources, list):\n        raw_sources = []\n\n    def _s(v):\n        return v if isinstance(v, str) else str(v or '')\n\n    sources_norm = []\n    if base_text.strip():\n        sources_norm.append({'source_id': 'transcript', 'kind': 'transcript', 'text': base_text, 'text_len_original': len(base_text)})\n\n    used = set([s.get('source_id') for s in sources_norm if isinstance(s, dict) and isinstance(s.get('source_id'), str)])\n\n    for idx, item in enumerate(raw_sources, start=1):\n        if not isinstance(item, dict):\n            continue\n\n        text = item.get('text')\n        if text is None:\n            text = item.get('content')\n        text = _s(text)\n        if not text.strip():\n            continue\n\n        kind = item.get('kind')\n        if kind is None:\n            kind = item.get('source_kind')\n        if kind is None:\n            kind = item.get('type')\n        kind = _s(kind).strip() or 'source'\n        kind2 = kind.lower()\n\n        source_id = item.get('source_id')\n        if source_id is None:\n            source_id = item.get('id')\n        if source_id is None:\n            source_id = item.get('name')\n        if source_id is None:\n            source_id = kind2\n        sid = _s(source_id).strip() or kind2\n        if sid in used:\n            sid = f\"{sid}-{idx}\"\n            while sid in used:\n                sid = f\"{sid}-{idx}\"\n        used.add(sid)\n\n        artifact_id = item.get('artifact_id')\n        if artifact_id is None:\n            artifact_id = item.get('span_id')\n        if artifact_id is None:\n            artifact_id = item.get('note_id')\n        artifact_id = _s(artifact_id).strip()\n\n        title = item.get('title')\n        if title is None:\n            title = item.get('label')\n        title = _s(title).strip()\n\n        orig_len = len(text)\n        truncated = False\n        if isinstance(max_source_chars, int) and max_source_chars > 0 and orig_len > max_source_chars:\n            text = text[:max_source_chars].rstrip() + \"\\n… [truncated]\\n\"\n            truncated = True\n\n        src = {'source_id': sid, 'kind': kind2, 'text': text, 'text_len_original': orig_len}\n        if truncated:\n            src['truncated'] = True\n        if artifact_id:\n            src['artifact_id'] = artifact_id\n        if title:\n            src['title'] = title\n        sources_norm.append(src)\n\n    # Build chat-friendly bundle text.\n    bundle = base_text.rstrip()\n\n    def _title_for(src):\n        t = src.get('title')\n        if isinstance(t, str) and t.strip():\n            return t.strip()\n        k = src.get('kind')\n        k2 = k if isinstance(k, str) else ''\n        k2 = k2.replace('_', ' ').strip()\n        return k2.title() if k2 else 'Source'\n\n    for src in sources_norm[1:]:\n        if not isinstance(src, dict):\n            continue\n        t = src.get('text')\n        if not isinstance(t, str) or not t.strip():\n            continue\n        hdr = [f\"source_id={src.get('source_id', '')}\", f\"kind={src.get('kind', '')}\"]\n        aid = src.get('artifact_id')\n        if isinstance(aid, str) and aid.strip():\n            hdr.append(f\"artifact_id={aid.strip()}\")\n        meta = ' · '.join([h for h in hdr if isinstance(h, str) and h.strip()])\n        block = [f\"SYSTEM: ## {_title_for(src)}\"]\n        if meta:\n            block.append(meta)\n        block.append('')\n        block.append(t.strip())\n\n        piece = \"\\n\\n\" + \"\\n\".join(block)\n        if isinstance(max_bundle_chars, int) and max_bundle_chars > 0:\n            if len(bundle) + len(piece) > max_bundle_chars:\n                break\n\n        bundle = (bundle + piece).strip()\n\n    # Input object for the extractor: replace text, avoid duplicating raw_sources.\n    out_input = dict(payload)\n    out_input['text'] = bundle\n    if 'sources' in out_input:\n        del out_input['sources']\n\n    sources_meta = {\n        'kind': 'kg_evidence_bundle',\n        'domain_focus': domain_focus.strip(),\n        'sources': [\n            {\n                'source_id': s.get('source_id'),\n                'kind': s.get('kind'),\n                'artifact_id': s.get('artifact_id'),\n                'title': s.get('title'),\n                'text_len': len(s.get('text') or '') if isinstance(s.get('text'), str) else 0,\n                'text_len_original': s.get('text_len_original') if isinstance(s.get('text_len_original'), int) else None,\n                'truncated': bool(s.get('truncated')),\n            }\n            for s in sources_norm\n            if isinstance(s, dict)\n        ],\n    }\n\n    return {\n        'input': out_input,\n        'bundle_text': bundle,\n        'sources': sources_norm,\n        'sources_meta': sources_meta,\n    }\n"
      }
    },
    {
      "id": "node-29",
      "type": "get",
      "position": { "x": 1984.0, "y": 256.0 },
      "data": {
        "nodeType": "get",
        "label": "Get bundle.input",
        "icon": "&#x1F4E5;",
        "headerColor": "#3498DB",
        "inputs": [
          { "id": "object", "label": "object", "type": "object" },
          { "id": "key", "label": "key", "type": "string" },
          { "id": "default", "label": "default", "type": "any" }
        ],
        "outputs": [{ "id": "value", "label": "value", "type": "any" }],
        "pinDefaults": { "key": "input", "default": {} }
      }
    },
    {
      "id": "node-30",
      "type": "get",
      "position": { "x": 1984.0, "y": 320.0 },
      "data": {
        "nodeType": "get",
        "label": "Get bundle.sources",
        "icon": "&#x1F4E5;",
        "headerColor": "#3498DB",
        "inputs": [
          { "id": "object", "label": "object", "type": "object" },
          { "id": "key", "label": "key", "type": "string" },
          { "id": "default", "label": "default", "type": "any" }
        ],
        "outputs": [{ "id": "value", "label": "value", "type": "any" }],
        "pinDefaults": { "key": "sources", "default": [] }
      }
    },
    {
      "id": "node-31",
      "type": "get",
      "position": { "x": 1984.0, "y": 384.0 },
      "data": {
        "nodeType": "get",
        "label": "Get bundle.sources_meta",
        "icon": "&#x1F4E5;",
        "headerColor": "#3498DB",
        "inputs": [
          { "id": "object", "label": "object", "type": "object" },
          { "id": "key", "label": "key", "type": "string" },
          { "id": "default", "label": "default", "type": "any" }
        ],
        "outputs": [{ "id": "value", "label": "value", "type": "any" }],
        "pinDefaults": { "key": "sources_meta", "default": {} }
      }
    },
    {
      "id": "node-7",
      "type": "subflow",
      "position": {
        "x": 1280.0,
        "y": 128.0
      },
      "data": {
        "nodeType": "subflow",
        "label": "Extract triples",
        "icon": "&#x1F4E6;",
        "headerColor": "#00CCCC",
        "inputs": [
          {
            "id": "exec-in",
            "label": "",
            "type": "execution"
          },
          {
            "id": "inherit_context",
            "label": "inherit_context",
            "type": "boolean",
            "description": "When true, seed the child run's context.messages from the parent's active context messages. If the pin is not connected, the node checkbox is used. Default: false."
          },
          {
            "id": "input",
            "label": "input",
            "type": "object"
          }
        ],
        "outputs": [
          {
            "id": "exec-out",
            "label": "",
            "type": "execution"
          },
          {
            "id": "output",
            "label": "output",
            "type": "object"
          }
        ],
        "subflowId": "ltm-ai-kg-extract-triples",
        "pinDefaults": {
          "inherit_context": false
        }
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-8",
      "type": "get",
      "position": {
        "x": 1504.0,
        "y": 128.0
      },
      "data": {
        "nodeType": "get",
        "label": "Get assertions",
        "icon": "&#x1F4E5;",
        "headerColor": "#3498DB",
        "inputs": [
          {
            "id": "object",
            "label": "object",
            "type": "object"
          },
          {
            "id": "key",
            "label": "key",
            "type": "string"
          },
          {
            "id": "default",
            "label": "default",
            "type": "any"
          }
        ],
        "outputs": [
          {
            "id": "value",
            "label": "value",
            "type": "any"
          }
        ],
        "pinDefaults": {
          "key": "assertions",
          "default": []
        }
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-32",
      "type": "make_object",
      "position": { "x": 1728.0, "y": 256.0 },
      "data": {
        "nodeType": "make_object",
        "label": "Source map input",
        "icon": "{}",
        "headerColor": "#3498DB",
        "inputs": [
          { "id": "assertions", "label": "assertions", "type": "any" },
          { "id": "sources", "label": "sources", "type": "any" }
        ],
        "outputs": [{ "id": "result", "label": "result", "type": "object" }]
      }
    },
    {
      "id": "node-33",
      "type": "code",
      "position": { "x": 1952.0, "y": 256.0 },
      "data": {
        "nodeType": "code",
        "label": "Attach evidence source",
        "icon": "&#x1F40D;",
        "headerColor": "#9B59B6",
        "inputs": [
          { "id": "exec-in", "label": "", "type": "execution" },
          { "id": "input", "label": "input", "type": "any" }
        ],
        "outputs": [
          { "id": "exec-out", "label": "", "type": "execution" },
          { "id": "output", "label": "output", "type": "any" }
        ],
        "functionName": "transform",
        "code": "def transform(_input):\n    payload = _input.get('input') if isinstance(_input, dict) else None\n    if not isinstance(payload, dict):\n        payload = {}\n\n    assertions = payload.get('assertions', [])\n    sources = payload.get('sources', [])\n\n    if not isinstance(assertions, list):\n        return []\n    if not isinstance(sources, list):\n        sources = []\n\n    def _s(v):\n        return v if isinstance(v, str) else str(v or '')\n\n    norm_sources = []\n    for s in sources:\n        if not isinstance(s, dict):\n            continue\n        text = s.get('text')\n        text = _s(text)\n        if not text:\n            continue\n        norm_sources.append(\n            {\n                'source_id': _s(s.get('source_id')).strip(),\n                'kind': _s(s.get('kind')).strip(),\n                'artifact_id': _s(s.get('artifact_id')).strip(),\n                'title': _s(s.get('title')).strip(),\n                'text': text,\n            }\n        )\n\n    out = []\n    for a in assertions:\n        if not isinstance(a, dict):\n            continue\n        attrs = a.get('attributes') if isinstance(a.get('attributes'), dict) else {}\n        evidence = attrs.get('evidence_quote')\n        evidence = evidence if isinstance(evidence, str) else ''\n        context = attrs.get('original_context') if isinstance(attrs.get('original_context'), str) else ''\n\n        match = None\n        if evidence:\n            for s in norm_sources:\n                if evidence in s.get('text', ''):\n                    match = s\n                    break\n        if match is None and context:\n            for s in norm_sources:\n                if context in s.get('text', ''):\n                    match = s\n                    break\n\n        a2 = dict(a)\n        if match is not None:\n            prov = a2.get('provenance') if isinstance(a2.get('provenance'), dict) else {}\n            prov2 = dict(prov)\n            if match.get('source_id'):\n                prov2.setdefault('source_id', match.get('source_id'))\n            if match.get('kind'):\n                prov2.setdefault('source_kind', match.get('kind'))\n            if match.get('artifact_id'):\n                prov2.setdefault('source_artifact_id', match.get('artifact_id'))\n            a2['provenance'] = prov2\n\n            attrs2 = dict(attrs)\n            if match.get('source_id'):\n                attrs2.setdefault('source_id', match.get('source_id'))\n            if match.get('kind'):\n                attrs2.setdefault('source_kind', match.get('kind'))\n            if match.get('artifact_id'):\n                attrs2.setdefault('source_artifact_id', match.get('artifact_id'))\n            if match.get('title'):\n                attrs2.setdefault('source_title', match.get('title'))\n            a2['attributes'] = attrs2\n\n        out.append(a2)\n\n    return out\n"
      }
    },
    {
      "id": "node-19",
      "type": "literal_json",
      "position": { "x": 1504.0, "y": 256.0 },
      "data": {
        "nodeType": "literal_json",
        "label": "KG attributes_defaults",
        "icon": "{}",
        "headerColor": "#00FFFF",
        "inputs": [],
        "outputs": [{ "id": "value", "label": "value", "type": "object" }],
        "literalValue": {}
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-20",
      "type": "get",
      "position": { "x": 1504.0, "y": 320.0 },
      "data": {
        "nodeType": "get",
        "label": "Get policy_version",
        "icon": "&#x1F4E5;",
        "headerColor": "#3498DB",
        "inputs": [
          { "id": "object", "label": "object", "type": "object" },
          { "id": "key", "label": "key", "type": "string" },
          { "id": "default", "label": "default", "type": "any" }
        ],
        "outputs": [{ "id": "value", "label": "value", "type": "any" }],
        "pinDefaults": { "key": "policy_version", "default": "kg_extract_persona_v1" }
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-21",
      "type": "get",
      "position": { "x": 1504.0, "y": 384.0 },
      "data": {
        "nodeType": "get",
        "label": "Get persona_id",
        "icon": "&#x1F4E5;",
        "headerColor": "#3498DB",
        "inputs": [
          { "id": "object", "label": "object", "type": "object" },
          { "id": "key", "label": "key", "type": "string" },
          { "id": "default", "label": "default", "type": "any" }
        ],
        "outputs": [{ "id": "value", "label": "value", "type": "any" }],
        "pinDefaults": { "key": "persona_id", "default": "default" }
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-22",
      "type": "get",
      "position": { "x": 1504.0, "y": 448.0 },
      "data": {
        "nodeType": "get",
        "label": "Get persona_version",
        "icon": "&#x1F4E5;",
        "headerColor": "#3498DB",
        "inputs": [
          { "id": "object", "label": "object", "type": "object" },
          { "id": "key", "label": "key", "type": "string" },
          { "id": "default", "label": "default", "type": "any" }
        ],
        "outputs": [{ "id": "value", "label": "value", "type": "any" }],
        "pinDefaults": { "key": "persona_version", "default": "v1" }
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-23",
      "type": "set",
      "position": { "x": 1728.0, "y": 288.0 },
      "data": {
        "nodeType": "set",
        "label": "Set extractor_policy_version",
        "icon": "&#x1F4E4;",
        "headerColor": "#3498DB",
        "inputs": [
          { "id": "object", "label": "object", "type": "object" },
          { "id": "key", "label": "key", "type": "string" },
          { "id": "value", "label": "value", "type": "any" }
        ],
        "outputs": [{ "id": "result", "label": "result", "type": "object" }],
        "pinDefaults": { "key": "extractor_policy_version" }
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-24",
      "type": "set",
      "position": { "x": 1728.0, "y": 352.0 },
      "data": {
        "nodeType": "set",
        "label": "Set persona_id",
        "icon": "&#x1F4E4;",
        "headerColor": "#3498DB",
        "inputs": [
          { "id": "object", "label": "object", "type": "object" },
          { "id": "key", "label": "key", "type": "string" },
          { "id": "value", "label": "value", "type": "any" }
        ],
        "outputs": [{ "id": "result", "label": "result", "type": "object" }],
        "pinDefaults": { "key": "persona_id" }
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-25",
      "type": "set",
      "position": { "x": 1728.0, "y": 416.0 },
      "data": {
        "nodeType": "set",
        "label": "Set persona_version",
        "icon": "&#x1F4E4;",
        "headerColor": "#3498DB",
        "inputs": [
          { "id": "object", "label": "object", "type": "object" },
          { "id": "key", "label": "key", "type": "string" },
          { "id": "value", "label": "value", "type": "any" }
        ],
        "outputs": [{ "id": "result", "label": "result", "type": "object" }],
        "pinDefaults": { "key": "persona_version" }
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-26",
      "type": "set",
      "position": { "x": 1728.0, "y": 480.0 },
      "data": {
        "nodeType": "set",
        "label": "Set extraction_input_kind",
        "icon": "&#x1F4E4;",
        "headerColor": "#3498DB",
        "inputs": [
          { "id": "object", "label": "object", "type": "object" },
          { "id": "key", "label": "key", "type": "string" },
          { "id": "value", "label": "value", "type": "any" }
        ],
        "outputs": [{ "id": "result", "label": "result", "type": "object" }],
        "pinDefaults": { "key": "extraction_input_kind", "value": "turn" }
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-9",
      "type": "memory_kg_assert",
      "position": {
        "x": 1728.0,
        "y": 128.0
      },
      "data": {
        "nodeType": "memory_kg_assert",
        "label": "Assert triples",
        "icon": "&#x1F9E0;",
        "headerColor": "#8E44AD",
        "inputs": [
          {
            "id": "exec-in",
            "label": "",
            "type": "execution"
          },
	          {
	            "id": "assertions",
	            "label": "assertions",
	            "type": "assertions",
	            "description": "List of {subject,predicate,object,...} assertion objects."
	          },
          {
            "id": "scope",
            "label": "scope",
            "type": "string",
            "description": "run | session | global. Determines the owner_id when not explicitly provided."
          },
          {
            "id": "span_id",
            "label": "span_id",
            "type": "string",
            "description": "Optional provenance pointer to a runtime span/artifact id."
          },
          {
            "id": "owner_id",
            "label": "owner_id",
            "type": "string",
            "description": "Optional explicit owner id override (advanced; normally derived from scope)."
          },
          {
            "id": "attributes_defaults",
            "label": "attributes_defaults",
            "type": "object",
            "description": "Optional attributes merged into each assertion.attributes (defaults only; assertion keys win)."
          }
        ],
        "outputs": [
          {
            "id": "exec-out",
            "label": "",
            "type": "execution"
          },
          {
            "id": "assertion_ids",
            "label": "assertion_ids",
            "type": "array",
            "description": "IDs assigned by the store (implementation-specific)."
          },
          {
            "id": "count",
            "label": "count",
            "type": "number",
            "description": "Number of asserted triples."
          },
          {
            "id": "ok",
            "label": "ok",
            "type": "boolean",
            "description": "True when assertion succeeded."
          },
          {
            "id": "raw",
            "label": "raw",
            "type": "object"
          }
        ]
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-12",
      "type": "length",
      "position": { "x": 1344.0, "y": 256.0 },
      "data": {
        "nodeType": "length",
        "label": "span_id len",
        "icon": "#",
        "headerColor": "#E74C3C",
        "inputs": [{ "id": "text", "label": "text", "type": "string" }],
        "outputs": [{ "id": "result", "label": "result", "type": "number" }]
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-13",
      "type": "compare",
      "position": { "x": 1520.0, "y": 256.0 },
      "data": {
        "nodeType": "compare",
        "label": "has span_id",
        "icon": "=?",
        "headerColor": "#F39C12",
        "inputs": [
          { "id": "a", "label": "a", "type": "any" },
          { "id": "op", "label": "op", "type": "string" },
          { "id": "b", "label": "b", "type": "any" }
        ],
        "outputs": [{ "id": "result", "label": "result", "type": "boolean" }],
        "pinDefaults": { "op": ">", "b": 0 }
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-14",
      "type": "if",
      "position": { "x": 1696.0, "y": 256.0 },
      "data": {
        "nodeType": "if",
        "label": "If span_id",
        "icon": "&#x2753;",
        "headerColor": "#F39C12",
        "inputs": [
          { "id": "exec-in", "label": "", "type": "execution" },
          { "id": "condition", "label": "condition", "type": "boolean" }
        ],
        "outputs": [
          { "id": "true", "label": "true", "type": "execution" },
          { "id": "false", "label": "false", "type": "execution" }
        ]
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-15",
      "type": "string_template",
      "position": { "x": 1520.0, "y": 384.0 },
      "data": {
        "nodeType": "string_template",
        "label": "Build source note",
        "icon": "&#x1F4DD;",
        "headerColor": "#3498DB",
        "inputs": [
          { "id": "template", "label": "template", "type": "string" },
          { "id": "vars", "label": "vars", "type": "object" }
        ],
        "outputs": [{ "id": "result", "label": "result", "type": "string" }],
        "pinDefaults": {
          "template": "# KG ingest-turn evidence bundle\\n\\n(domain_focus={{domain_focus}})\\n\\n{{text}}"
        }
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-16",
      "type": "memory_note",
      "position": { "x": 1696.0, "y": 384.0 },
      "data": {
        "nodeType": "memory_note",
        "label": "Store source span",
        "icon": "&#x1F4DD;",
        "headerColor": "#2ECC71",
        "inputs": [
          { "id": "exec-in", "label": "", "type": "execution" },
          { "id": "keep_in_context", "label": "in_context", "type": "boolean" },
          { "id": "scope", "label": "scope", "type": "string" },
          { "id": "content", "label": "content", "type": "string" },
          { "id": "location", "label": "location", "type": "string" },
          { "id": "tags", "label": "tags", "type": "object" },
          { "id": "sources", "label": "sources", "type": "object" }
        ],
        "outputs": [
          { "id": "exec-out", "label": "", "type": "execution" },
          { "id": "note_id", "label": "note_id", "type": "string" }
        ],
        "pinDefaults": {
          "keep_in_context": false,
          "scope": "run",
          "location": "kg_ingest_turn_source",
          "tags": { "kind": "kg_ingest_turn_source" }
        }
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-17",
      "type": "coalesce",
      "position": { "x": 1520.0, "y": 512.0 },
      "data": {
        "nodeType": "coalesce",
        "label": "span_id (fallback note)",
        "icon": "&#x1F517;",
        "headerColor": "#3498DB",
        "inputs": [
          { "id": "a", "label": "span_id", "type": "any" },
          { "id": "b", "label": "fallback", "type": "any" }
        ],
        "outputs": [{ "id": "result", "label": "result", "type": "any" }]
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    },
    {
      "id": "node-10",
      "type": "on_flow_end",
      "position": {
        "x": 1952.0,
        "y": 128.0
      },
      "data": {
        "nodeType": "on_flow_end",
        "label": "End",
        "icon": "&#x23F9;",
        "headerColor": "#C0392B",
        "inputs": [
          {
            "id": "exec-in",
            "label": "",
            "type": "execution"
          },
          {
            "id": "extracted",
            "label": "extracted",
            "type": "object"
          },
          {
            "id": "assertion_ids",
            "label": "assertion_ids",
            "type": "array"
          },
          {
            "id": "count",
            "label": "count",
            "type": "number"
          },
          {
            "id": "ok",
            "label": "ok",
            "type": "boolean"
          }
        ],
        "outputs": []
      },
      "label": null,
      "icon": null,
      "headerColor": null,
      "inputs": [],
      "outputs": []
    }
  ],
  "edges": [
    {
      "id": "edge-1",
      "source": "node-2",
      "sourceHandle": "value",
      "target": "node-3",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-2",
      "source": "node-1",
      "sourceHandle": "provider",
      "target": "node-3",
      "targetHandle": "value",
      "animated": false
    },
    {
      "id": "edge-3",
      "source": "node-3",
      "sourceHandle": "result",
      "target": "node-4",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-4",
      "source": "node-1",
      "sourceHandle": "model",
      "target": "node-4",
      "targetHandle": "value",
      "animated": false
    },
    {
      "id": "edge-5",
      "source": "node-4",
      "sourceHandle": "result",
      "target": "node-5",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-6",
      "source": "node-1",
      "sourceHandle": "text",
      "target": "node-5",
      "targetHandle": "value",
      "animated": false
    },
    {
      "id": "edge-7",
      "source": "node-5",
      "sourceHandle": "result",
      "target": "node-6",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-8",
      "source": "node-1",
      "sourceHandle": "domain_focus",
      "target": "node-6",
      "targetHandle": "value",
      "animated": false
    },
    {
      "id": "edge-9",
      "source": "node-6",
      "sourceHandle": "result",
      "target": "node-11",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-9b",
      "source": "node-1",
      "sourceHandle": "max_out_tokens",
      "target": "node-11",
      "targetHandle": "value",
      "animated": false
    },
    {
      "id": "edge-9c1",
      "source": "node-11",
      "sourceHandle": "result",
      "target": "node-18",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-9c2",
      "source": "node-1",
      "sourceHandle": "extraction_profile",
      "target": "node-18",
      "targetHandle": "value",
      "animated": false
    },
    {
      "id": "edge-9c",
      "source": "node-29",
      "sourceHandle": "value",
      "target": "node-7",
      "targetHandle": "input",
      "animated": false
    },
    {
      "id": "edge-9c3",
      "source": "node-18",
      "sourceHandle": "result",
      "target": "node-27",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-9c4",
      "source": "node-1",
      "sourceHandle": "sources",
      "target": "node-27",
      "targetHandle": "value",
      "animated": false
    },
    {
      "id": "edge-9c5",
      "source": "node-27",
      "sourceHandle": "result",
      "target": "node-28",
      "targetHandle": "input",
      "animated": false
    },
    {
      "id": "edge-9c6",
      "source": "node-28",
      "sourceHandle": "output",
      "target": "node-29",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-9c7",
      "source": "node-28",
      "sourceHandle": "output",
      "target": "node-30",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-9c8",
      "source": "node-28",
      "sourceHandle": "output",
      "target": "node-31",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-10",
      "source": "node-1",
      "sourceHandle": "exec-out",
      "target": "node-28",
      "targetHandle": "exec-in",
      "animated": true
    },
    {
      "id": "edge-10b",
      "source": "node-28",
      "sourceHandle": "exec-out",
      "target": "node-7",
      "targetHandle": "exec-in",
      "animated": true
    },
    {
      "id": "edge-11",
      "source": "node-7",
      "sourceHandle": "output",
      "target": "node-8",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-11b",
      "source": "node-8",
      "sourceHandle": "value",
      "target": "node-32",
      "targetHandle": "assertions",
      "animated": false
    },
    {
      "id": "edge-11c",
      "source": "node-30",
      "sourceHandle": "value",
      "target": "node-32",
      "targetHandle": "sources",
      "animated": false
    },
    {
      "id": "edge-11d",
      "source": "node-32",
      "sourceHandle": "result",
      "target": "node-33",
      "targetHandle": "input",
      "animated": false
    },
    {
      "id": "edge-12",
      "source": "node-33",
      "sourceHandle": "output",
      "target": "node-9",
      "targetHandle": "assertions",
      "animated": false
    },
    {
      "id": "edge-12a",
      "source": "node-1",
      "sourceHandle": "extraction_profile",
      "target": "node-20",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-12b",
      "source": "node-1",
      "sourceHandle": "extraction_profile",
      "target": "node-21",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-12c",
      "source": "node-1",
      "sourceHandle": "extraction_profile",
      "target": "node-22",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-12d",
      "source": "node-19",
      "sourceHandle": "value",
      "target": "node-23",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-12e",
      "source": "node-20",
      "sourceHandle": "value",
      "target": "node-23",
      "targetHandle": "value",
      "animated": false
    },
    {
      "id": "edge-12f",
      "source": "node-23",
      "sourceHandle": "result",
      "target": "node-24",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-12g",
      "source": "node-21",
      "sourceHandle": "value",
      "target": "node-24",
      "targetHandle": "value",
      "animated": false
    },
    {
      "id": "edge-12h",
      "source": "node-24",
      "sourceHandle": "result",
      "target": "node-25",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-12i",
      "source": "node-22",
      "sourceHandle": "value",
      "target": "node-25",
      "targetHandle": "value",
      "animated": false
    },
    {
      "id": "edge-12j",
      "source": "node-25",
      "sourceHandle": "result",
      "target": "node-26",
      "targetHandle": "object",
      "animated": false
    },
    {
      "id": "edge-12k",
      "source": "node-26",
      "sourceHandle": "result",
      "target": "node-9",
      "targetHandle": "attributes_defaults",
      "animated": false
    },
    {
      "id": "edge-13",
      "source": "node-1",
      "sourceHandle": "scope",
      "target": "node-9",
      "targetHandle": "scope",
      "animated": false
    },
    {
      "id": "edge-14",
      "source": "node-1",
      "sourceHandle": "span_id",
      "target": "node-17",
      "targetHandle": "a",
      "animated": false
    },
    {
      "id": "edge-15",
      "source": "node-33",
      "sourceHandle": "exec-out",
      "target": "node-14",
      "targetHandle": "exec-in",
      "animated": true
    },
    {
      "id": "edge-15b",
      "source": "node-7",
      "sourceHandle": "exec-out",
      "target": "node-33",
      "targetHandle": "exec-in",
      "animated": true
    },
    {
      "id": "edge-21",
      "source": "node-1",
      "sourceHandle": "span_id",
      "target": "node-12",
      "targetHandle": "text",
      "animated": false
    },
    {
      "id": "edge-22",
      "source": "node-12",
      "sourceHandle": "result",
      "target": "node-13",
      "targetHandle": "a",
      "animated": false
    },
    {
      "id": "edge-23",
      "source": "node-13",
      "sourceHandle": "result",
      "target": "node-14",
      "targetHandle": "condition",
      "animated": false
    },
    {
      "id": "edge-24",
      "source": "node-14",
      "sourceHandle": "true",
      "target": "node-9",
      "targetHandle": "exec-in",
      "animated": true
    },
    {
      "id": "edge-25",
      "source": "node-14",
      "sourceHandle": "false",
      "target": "node-16",
      "targetHandle": "exec-in",
      "animated": true
    },
    {
      "id": "edge-26",
      "source": "node-16",
      "sourceHandle": "exec-out",
      "target": "node-9",
      "targetHandle": "exec-in",
      "animated": true
    },
    {
      "id": "edge-27",
      "source": "node-29",
      "sourceHandle": "value",
      "target": "node-15",
      "targetHandle": "vars",
      "animated": false
    },
    {
      "id": "edge-28",
      "source": "node-15",
      "sourceHandle": "result",
      "target": "node-16",
      "targetHandle": "content",
      "animated": false
    },
    {
      "id": "edge-28b",
      "source": "node-31",
      "sourceHandle": "value",
      "target": "node-16",
      "targetHandle": "sources",
      "animated": false
    },
    {
      "id": "edge-29",
      "source": "node-16",
      "sourceHandle": "note_id",
      "target": "node-17",
      "targetHandle": "b",
      "animated": false
    },
    {
      "id": "edge-30",
      "source": "node-17",
      "sourceHandle": "result",
      "target": "node-9",
      "targetHandle": "span_id",
      "animated": false
    },
    {
      "id": "edge-16",
      "source": "node-7",
      "sourceHandle": "output",
      "target": "node-10",
      "targetHandle": "extracted",
      "animated": false
    },
    {
      "id": "edge-17",
      "source": "node-9",
      "sourceHandle": "assertion_ids",
      "target": "node-10",
      "targetHandle": "assertion_ids",
      "animated": false
    },
    {
      "id": "edge-18",
      "source": "node-9",
      "sourceHandle": "count",
      "target": "node-10",
      "targetHandle": "count",
      "animated": false
    },
    {
      "id": "edge-19",
      "source": "node-9",
      "sourceHandle": "ok",
      "target": "node-10",
      "targetHandle": "ok",
      "animated": false
    },
    {
      "id": "edge-20",
      "source": "node-9",
      "sourceHandle": "exec-out",
      "target": "node-10",
      "targetHandle": "exec-in",
      "animated": true
    }
  ],
  "entryNode": "node-1",
  "created_at": null,
  "updated_at": "2026-01-17T07:33:12.069302"
}
